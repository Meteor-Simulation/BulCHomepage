# BulC Homepage 배포 작업 기록

> 작성일: 2026-02-13
> 작업자: Claude Code (Opus 4.6) + 강주원
> 상태: **진행 중** (Oracle Cloud Security List 설정 대기)

---

## 1. 배포 아키텍처 (확정)

```
[사용자 브라우저]
       |
       v
[Cloudflare Pages]  <-- 프론트엔드 (React 정적 빌드)
  bulc.msimul.com       무료, CDN, HTTPS 자동
  (현재: bulchomepage.pages.dev)
       |
       |  API 호출 (HTTPS)
       v
[Oracle Cloud VM]   <-- 백엔드 (Spring Boot 3.2.5) + DB (PostgreSQL 16)
  api.msimul.com        Always Free VM.Standard.E2.1.Micro (1 OCPU, 1GB RAM)
  IP: 168.107.19.139    Docker Compose + Nginx 리버스 프록시
```

### 배포 가이드 대비 변경점

| 항목 | 가이드 원안 | 실제 적용 | 사유 |
|------|-------------|-----------|------|
| VM Shape | VM.Standard.A1.Flex (ARM, 4 OCPU, 24GB) | VM.Standard.E2.1.Micro (AMD, 1 OCPU, 1GB) | 춘천 리전 ARM 인스턴스 용량 부족 (Out of Capacity) |
| RAM | 12~24GB | 1GB + 2GB Swap | E2.1.Micro 무료 티어 제한, Swap으로 보완 |
| Spring Boot | 3.2.0 | 3.2.5 | 3.2.0의 ZipContent 로더 버그 수정 (NegativeArraySizeException) |
| Dockerfile | gradlew 기반 빌드 | Gradle 공식 이미지 빌드 | gradle-wrapper.jar가 .gitignore(*.jar)로 누락 |
| Java 힙 | -Xms512m -Xmx1024m | -Xms128m -Xmx384m | 1GB RAM 서버에 맞게 축소 |
| 프론트엔드 서비스 | docker-compose에 포함 | 제거 | Cloudflare Pages에서 서빙하므로 불필요 |

---

## 2. 작업 순서 (시간순)

### Phase A: 프론트엔드 배포 (Cloudflare Pages)

#### A-1. Cloudflare Pages 프로젝트 생성
- Cloudflare 대시보드 > Workers & Pages > Create
- GitHub 연동 > `Meteor-Simulation/BulCHomepage` 레포 선택
- 빌드 설정:
  - Production branch: `main`
  - Build command: `CI=false npm run build` (원래 `npm run build`)
  - Build output directory: `build`
  - Root directory: `frontend`

#### A-2. 첫 번째 빌드 실패 - package-lock.json 동기화
- **문제**: `npm ci` 실패. `yaml@2.8.2`가 package.json에는 있지만 package-lock.json에 누락
- **해결**: 로컬에서 `npm install` 실행하여 package-lock.json 갱신
- **커밋**: PR #39로 main 브랜치에 반영
- **프로젝트 변경**: `frontend/package-lock.json` 업데이트

#### A-3. 두 번째 빌드 실패 - ESLint 경고
- **문제**: Cloudflare 빌드 환경에서 `CI=true`가 기본값. ESLint 경고(unused imports 등)가 에러로 처리됨
  - `MyPage.tsx`, `Payment.tsx`, `Header.tsx`에서 미사용 import 경고
- **해결**: 빌드 명령어를 `CI=false npm run build`로 변경
- **프로젝트 변경 없음** (Cloudflare 설정만 변경)

#### A-4. 빌드 성공
- 배포 URL: `https://bulchomepage.pages.dev`
- 정상 접속 확인

#### A-5. 커스텀 도메인 설정 시작
- Cloudflare Pages > Custom domains > `bulc.msimul.com` 추가
- DNS 제공업체(msimul.com 관리자)에서 CNAME 레코드 추가 필요:
  ```
  bulc.msimul.com → bulchomepage.pages.dev
  ```

---

### Phase B: 백엔드 + DB 배포 (Oracle Cloud VM)

#### B-1. Oracle Cloud VM 인스턴스 생성
- 리전: ap-chuncheon-1 (춘천)
- Shape: VM.Standard.E2.1.Micro (Always Free)
  - 1 OCPU, 1GB RAM, 50GB Boot Volume
- OS: Ubuntu 22.04
- SSH 키 생성 및 다운로드
- Public IPv4 할당

#### B-2. Security List 생성 및 서브넷 연결
- VCN > Security Lists > 새 Security List 생성
- Ingress Rules: TCP 22(SSH), 80(HTTP), 443(HTTPS)
- 해당 Security List를 서브넷에 연결

#### B-3. SSH 접속 확인
- SSH 키: `Document/배포 준비 문서/key/ssh-key-2026-02-13.key`
- 접속: `ssh -i <key> ubuntu@168.107.19.139`

#### B-4. 서버 초기 설정
```
1. 시스템 업데이트: sudo apt update && sudo apt upgrade -y
2. Swap 파일 생성: 2GB (/swapfile, swappiness=60)
   → 사유: 1GB RAM으로는 Java 빌드 및 런타임에 메모리 부족
3. Docker 설치: curl -fsSL https://get.docker.com | sudo sh
4. Docker Compose 설치: sudo apt install docker-compose-plugin -y
```

#### B-5. 프로젝트 클론 및 환경 설정
```
1. git clone https://github.com/Meteor-Simulation/BulCHomepage.git
2. .env.prod 생성 (JWT 시크릿, DB 비밀번호 자동 생성)
3. RS256 라이선스 키 쌍 생성 (secrets/ 디렉토리)
```

#### B-6. Docker 이미지 빌드 (3회 시도)

**1차 빌드 실패** - Gradle Wrapper JAR 누락
- **문제**: `.gitignore`에 `*.jar` 포함 → `gradle-wrapper.jar`가 커밋되지 않음
- **에러**: `ClassNotFoundException: org.gradle.wrapper.GradleWrapperMain`
- **해결**: Dockerfile을 `gradle:8.5-jdk17` 공식 이미지 기반으로 변경

**2차 빌드 성공, 런타임 실패** - Spring Boot 3.2.0 로더 버그
- **문제**: `NegativeArraySizeException: -27305` (ZipContent$Loader)
- **원인**: Spring Boot 3.2.0의 새 nested JAR 로더 버그 (3.2.1에서 수정됨)
- **해결**: `build.gradle`에서 Spring Boot 버전을 3.2.0 → 3.2.5로 업그레이드

**3차 빌드 성공, 런타임 실패** - 라이선스 키 파일 문제
- **문제**: `SigningKeyProvider: RS256 개인키가 설정되지 않았습니다`
- **원인 1**: secrets 볼륨이 docker-compose에 마운트되지 않음
- **원인 2**: 키 파일 권한이 600(owner only)으로 컨테이너의 appuser가 읽기 불가
- **해결**: docker-compose.prod.yml에 볼륨 마운트 추가 + 키 파일 권한 644로 변경

#### B-7. 백엔드 정상 기동 확인
```
Started HomepageApplication in 63.109 seconds
Health check: {"status":"UP","message":"BulC Homepage Backend is running!"}
```

#### B-8. Nginx 리버스 프록시 설정
- Nginx + Certbot 설치
- `/etc/nginx/sites-available/api.msimul.com` 설정 (HTTP, CORS 포함)
- 현재 HTTP 기본 설정만 완료 (SSL은 도메인 DNS 설정 후 진행)

#### B-9. VM 내부 방화벽 설정
- iptables/nftables에 포트 80, 443 인바운드 규칙 추가
- `sudo iptables-save` / `netfilter-persistent save`로 영구 저장

#### B-10. 외부 접속 테스트 - 실패
- **문제**: Oracle Cloud Security List에서 포트 80, 443이 실제로 열리지 않음
- **상태**: **Oracle Cloud 콘솔에서 Security List Ingress Rules 확인 필요**

---

## 3. 프로젝트 소스코드 변경 내역

### 3-1. 서버(Oracle VM)에서만 변경 (Git 미반영, 서버 로컬)

| 파일 | 변경 내용 | 사유 |
|------|-----------|------|
| `backend/Dockerfile` | gradlew 기반 → Gradle 공식 이미지 기반 빌드로 변경, 메모리 제한 추가 | gradle-wrapper.jar 누락(.gitignore에 *.jar) + 1GB RAM 서버 대응 |
| `backend/build.gradle` | Spring Boot 3.2.0 → 3.2.5 | 3.2.0의 ZipContent NegativeArraySizeException 버그 수정 |
| `docker-compose.prod.yml` | frontend 서비스 제거, backend ports 추가(127.0.0.1:8080), secrets 볼륨 마운트 추가, version 제거 | 프론트는 Cloudflare, 백엔드 포트 Nginx 연동, 라이선스 키 접근, Docker Compose 경고 제거 |
| `.env.prod` | 새로 생성 (DB/JWT/CORS 실제 값) | 프로덕션 환경변수 |
| `secrets/` | RS256 키 쌍 생성 (session_token_private_key.pem, session_token_public_key.pem) | 라이선스 서비스 필수 |

### 3-2. Git에 반영된 변경 (이전 커밋)

| 파일 | 변경 내용 | 사유 | PR |
|------|-----------|------|-----|
| `frontend/package-lock.json` | yaml@2.8.2 의존성 동기화 | Cloudflare Pages npm ci 빌드 실패 해결 | #39 |
| `frontend/src/CategoryPages/BULC/BulC.tsx` | 언어 전환 버튼 제거 | 개발용 테스트 버튼, 프로덕션에서 불필요 | 이전 커밋 |
| `frontend/src/CategoryPages/BULC/BulC.css` | .bulc-lang-toggle 스타일 제거 | 언어 전환 버튼 관련 CSS 정리 | 이전 커밋 |
| `frontend/src/components/Header.css` | floating-contact-btn bottom 값 변경 (100→170px 등) | 문의 버튼 위치 상향 조정 | 이전 커밋 |
| `frontend/src/components/Footer.css` | .footer-section text-align: center 추가 | 푸터 텍스트 가운데 정렬 | 이전 커밋 |
| `Document/배포 준비 문서/배포_가이드.md` | 배포 가이드 문서 신규 생성 | 배포 절차 문서화 | 이전 커밋 |

### 3-3. Git에 반영 필요한 변경 (서버에서 검증 후)

| 파일 | 변경 내용 | 사유 |
|------|-----------|------|
| `backend/Dockerfile` | Gradle 공식 이미지 + 메모리 제한 | 빌드 안정성, 저사양 서버 지원 |
| `backend/build.gradle` | Spring Boot 3.2.0 → 3.2.5 | 런타임 버그 수정 |
| `docker-compose.prod.yml` | frontend 제거, backend 포트/볼륨 추가 | 실제 배포 환경 반영 |
| `.gitignore` | `!gradle/wrapper/gradle-wrapper.jar` 예외 추가 검토 | Dockerfile에서 gradlew 사용 시 필요 |

---

## 4. 서버에서 변경한 파일 상세

### 4-1. backend/Dockerfile (변경 후)
```dockerfile
FROM gradle:8.5-jdk17 AS builder
WORKDIR /app
ENV GRADLE_OPTS="-Xms256m -Xmx512m -Dorg.gradle.jvmargs=-Xmx512m"
COPY build.gradle .
COPY settings.gradle .
RUN gradle dependencies --no-daemon || true
COPY src src
RUN gradle bootJar --no-daemon -x test

FROM eclipse-temurin:17-jre
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar
RUN groupadd -r appgroup && useradd -r -g appgroup appuser
USER appuser
EXPOSE 8080
ENTRYPOINT ["java", "-XX:+UseContainerSupport", "-XX:MaxRAMPercentage=50.0", "-Xms128m", "-Xmx384m", "-jar", "app.jar"]
```

**변경 사유:**
1. `gradle:8.5-jdk17` 사용 → gradle-wrapper.jar 누락 문제 해결
2. `GRADLE_OPTS` 메모리 제한 → 1GB RAM 빌드 환경에서 OOM 방지
3. `-x test` 추가 → 서버에서 테스트 실행 불필요 (CI에서 수행)
4. `-Xms128m -Xmx384m` → 런타임 메모리를 1GB 서버에 맞게 축소
5. `-XX:MaxRAMPercentage=50.0` → 컨테이너 메모리의 50%만 사용 (DB와 공존)

### 4-2. docker-compose.prod.yml (변경 후)
```yaml
services:
  database:
    image: postgres:16-alpine
    container_name: bulc-db-prod
    restart: always
    environment: [DB 환경변수]
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck: [pg_isready]
    networks: [bulc-network-prod]

  backend:
    build: ./backend
    container_name: bulc-backend-prod
    restart: always
    ports:
      - "127.0.0.1:8080:8080"   # 추가: Nginx에서 접근
    environment: [Spring Boot 환경변수 + LIC_*_PATH]
    volumes:                      # 추가: 라이선스 키 마운트
      - ./secrets/session_token_private_key.pem:/run/secrets/session_token_private_key.pem:ro
      - ./secrets/session_token_public_key.pem:/run/secrets/session_token_public_key.pem:ro
    depends_on:
      database: { condition: service_healthy }
    networks: [bulc-network-prod]
```

**변경 사유:**
1. `version: '3.8'` 제거 → Docker Compose v2에서 obsolete 경고
2. `frontend` 서비스 제거 → Cloudflare Pages에서 서빙
3. `ports: "127.0.0.1:8080:8080"` → Nginx 리버스 프록시 연동 (외부 직접 노출 방지)
4. `volumes` 추가 → 라이선스 RS256 키 파일을 컨테이너 내부에 마운트
5. `LIC_PRIVATE_KEY_PATH`, `LIC_PUBLIC_KEY_PATH` 환경변수 추가

### 4-3. backend/build.gradle (변경 부분)
```groovy
// 변경 전
id 'org.springframework.boot' version '3.2.0'

// 변경 후
id 'org.springframework.boot' version '3.2.5'
```

**변경 사유:**
Spring Boot 3.2.0의 `ZipContent$Loader`에서 `NegativeArraySizeException: -27305` 발생.
이는 Spring Boot 3.2.0에서 도입된 새로운 nested JAR 로더의 알려진 버그로, 3.2.1에서 수정됨.
안정성을 위해 3.2.5(3.2.x 최신 패치)로 업그레이드.

---

## 5. 남은 작업 (TODO)

### 즉시 필요

- [ ] **Oracle Cloud Security List 인바운드 규칙 확인/추가**
  - 포트 80 (TCP, 0.0.0.0/0)
  - 포트 443 (TCP, 0.0.0.0/0)
  - 콘솔: Networking > VCN > Subnets > Security Lists > Ingress Rules

- [ ] **외부에서 HTTP 접근 테스트**
  ```bash
  curl http://168.107.19.139/api/health
  ```

### 도메인 및 SSL

- [ ] **api.msimul.com DNS A 레코드 설정**
  - DNS 관리 콘솔에서 A 레코드: `api.msimul.com → 168.107.19.139`

- [ ] **bulc.msimul.com DNS CNAME 레코드 설정**
  - DNS 관리 콘솔에서 CNAME: `bulc.msimul.com → bulchomepage.pages.dev`

- [ ] **SSL 인증서 발급 (Let's Encrypt)**
  ```bash
  sudo certbot --nginx -d api.msimul.com
  ```

- [ ] **Nginx HTTPS 설정 업데이트**
  - HTTP → HTTPS 리다이렉트 추가
  - SSL 인증서 경로 설정

- [ ] **SSL 자동 갱신 확인**
  ```bash
  sudo certbot renew --dry-run
  ```

### Cloudflare Pages 설정

- [ ] **환경변수 설정**
  - `REACT_APP_API_URL` = `https://api.msimul.com`
  - (백엔드 SSL 설정 완료 후)

- [ ] **SPA 라우팅 설정 확인**
  - `frontend/public/_redirects` 파일 존재 여부 확인
  - 내용: `/*    /index.html   200`

### 프로덕션 환경변수 (서버 .env.prod)

- [ ] **OAuth2 실제 키 설정** (현재 placeholder)
  - Naver 개발자 콘솔 → 프로덕션 클라이언트 ID/Secret
  - Kakao 개발자 콘솔 → 프로덕션 클라이언트 ID/Secret
  - Google Cloud Console → 프로덕션 클라이언트 ID/Secret
  - 각 콘솔에서 리다이렉트 URI 업데이트 필수

- [ ] **Microsoft Graph Mail 설정** (현재 placeholder → 로그 출력 모드)
  - Azure Portal → MS_TENANT_ID, MS_CLIENT_ID, MS_CLIENT_SECRET

- [ ] **Toss Payments 설정** (현재 미설정)
  - 토스페이먼츠 개발자센터 → 프로덕션 키

### Git 반영

- [ ] **서버에서 검증된 변경사항 Git 커밋**
  - `backend/Dockerfile` 수정
  - `backend/build.gradle` Spring Boot 버전 업그레이드
  - `docker-compose.prod.yml` 프로덕션 환경 반영
  - 브랜치 생성 → PR → main 머지

### 배포 후 점검 (배포 가이드 Phase 5)

- [ ] HTTPS 정상 동작 (프론트 + 백엔드 모두)
- [ ] API CORS 정상 (프론트에서 백엔드 API 호출)
- [ ] 회원가입 / 로그인 동작
- [ ] OAuth 소셜 로그인 (Google, Kakao, Naver)
- [ ] 결제 (토스페이먼츠)
- [ ] 이메일 발송 (Microsoft Graph)
- [ ] 라이선스 발급/검증
- [ ] DB 백업 스크립트 설정

---

## 6. 현재 서버 상태

| 컴포넌트 | 상태 | 비고 |
|----------|------|------|
| VM | 정상 | Ubuntu 22.04, 1 OCPU, 1GB RAM + 2GB Swap |
| Docker | v29.2.1 | 정상 |
| Docker Compose | v5.0.2 | 정상 |
| PostgreSQL 16 | 정상 (healthy) | bulc-db-prod 컨테이너 |
| Spring Boot 3.2.5 | 정상 (UP) | bulc-backend-prod, 포트 8080 |
| Nginx | 정상 | 포트 80 리스닝, api.msimul.com 설정 |
| 내부 방화벽 | 포트 22/80/443 개방 | iptables + nftables |
| **외부 접근** | **차단됨** | **Oracle Cloud Security List 설정 필요** |

---

## 7. 비용 (확정)

| 서비스 | 월 비용 | 비고 |
|--------|---------|------|
| Cloudflare Pages | 무료 | 대역폭 무제한, 빌드 500회/월 |
| Oracle Cloud VM | 무료 | Always Free E2.1.Micro (1 OCPU, 1GB RAM) |
| 도메인 (msimul.com) | 이미 보유 | 추가 비용 없음 |
| SSL (Let's Encrypt) | 무료 | 90일 자동 갱신 |
| **합계** | **월 0원** | |

---

## 8. 배포 가이드 체크리스트 진행 상황

### Phase 1: 사전 준비
- [ ] Cloudflare에 msimul.com 도메인 등록 → **도메인은 별도 관리, Cloudflare Pages만 사용**
- [x] Oracle Cloud 계정 생성 (춘천 리전)
- [x] JWT 시크릿 생성
- [x] RS256 라이선스 키 생성
- [ ] OAuth 키 프로덕션 설정 → **미완료 (placeholder)**

### Phase 2: 서버 구축
- [x] VM 인스턴스 생성 (E2.1.Micro)
- [x] Security List 생성 (포트 22/80/443) → **외부 접근 차단 문제 확인 필요**
- [x] VM 초기 설정 (업데이트, Docker, Swap)

### Phase 3: DB + 백엔드 배포
- [x] 프로젝트 클론
- [x] .env.prod 생성
- [x] secrets 디렉토리 준비 (RS256 키)
- [x] Nginx 설치 및 HTTP 설정
- [ ] SSL 인증서 발급 → **도메인 DNS 설정 후 진행**
- [x] Docker Compose 실행 (DB + 백엔드 정상)
- [x] 내부 헬스체크 통과 (`localhost:8080/api/health`)
- [ ] 외부 헬스체크 → **Security List 해결 후 진행**

### Phase 4: 프론트엔드 배포
- [x] Cloudflare Pages 프로젝트 생성
- [x] GitHub 연동 및 빌드 성공
- [x] 빌드 설정 (CI=false npm run build)
- [ ] 환경변수 설정 (REACT_APP_API_URL) → **백엔드 SSL 후 설정**
- [ ] SPA 라우팅 설정 (_redirects) → **확인 필요**
- [ ] 커스텀 도메인 연결 → **DNS CNAME 설정 필요**

### Phase 5: 배포 후 점검
- [ ] 전체 미완료 → **기본 인프라 완료 후 진행**
