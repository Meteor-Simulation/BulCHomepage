# BulC Homepage 배포 가이드

> 작성일: 2026-02-13
> 대상: 프론트엔드 / 백엔드 / DB 분리 배포

---

## 배포 구성도

```
[사용자 브라우저]
       │
       ▼
[Cloudflare Pages]  ←── 프론트엔드 (React 정적 빌드)
  bulc.msimul.com        무료, CDN, HTTPS 자동
       │
       │  API 호출 (HTTPS)
       ▼
[Oracle Cloud VM]   ←── 백엔드 (Spring Boot) + DB (PostgreSQL)
  api.msimul.com         영구 무료 ARM VM (4 OCPU, 24GB RAM)
                         Docker Compose로 백엔드 + DB 함께 운영
```

### 도메인 구조 (예시)
| 서비스 | 도메인 | 설명 |
|--------|--------|------|
| 프론트엔드 | `bulc.msimul.com` | Cloudflare Pages (CNAME) |
| 백엔드 API | `api.msimul.com` | Oracle Cloud VM (A 레코드) |
| DB | 내부 접근만 | 외부 노출 금지 |

---

## 작업 순서

### Phase 1: 사전 준비

#### 1-1. 도메인 설정
- [ ] Cloudflare에 `msimul.com` 도메인 등록 (네임서버 변경)
- [ ] Cloudflare DNS에서 관리할 수 있도록 설정 완료 확인

#### 1-2. Oracle Cloud 계정 생성
- [ ] https://cloud.oracle.com 가입 (신용카드 등록 필요, 과금 안 됨)
- [ ] 리전 선택: **ap-chuncheon-1 (춘천)** 또는 **ap-seoul-1 (서울)**
- [ ] Always Free 티어 확인

#### 1-3. 보안 키 준비
- [ ] JWT 시크릿 생성: `openssl rand -base64 64`
- [ ] 라이선스 RS256 키: `session_token_private_key.pem` 준비
- [ ] OAuth 키 (Google, Kakao, Naver) - 각 개발자 콘솔에서 프로덕션 URL로 재설정

---

### Phase 2: 서버 구축 (Oracle Cloud VM)

#### 2-1. VM 인스턴스 생성
- [ ] Compute > Instances > Create Instance
- [ ] Shape: **VM.Standard.A1.Flex** (ARM, Always Free)
  - OCPU: 2~4개 (최대 4개 무료)
  - RAM: 12~24GB (최대 24GB 무료)
- [ ] OS: **Ubuntu 22.04** (또는 Oracle Linux)
- [ ] SSH 키 생성 및 다운로드
- [ ] 부트 볼륨: 50GB (기본, 무료)

#### 2-2. 네트워크 보안 규칙 (Security List)
- [ ] 인바운드 허용 포트:
  ```
  22    (SSH)
  80    (HTTP → HTTPS 리다이렉트)
  443   (HTTPS)
  ```
- [ ] **5432 (PostgreSQL)는 절대 외부에 열지 않음**
- [ ] Oracle Cloud 기본 방화벽 + VM 내부 iptables 둘 다 설정

#### 2-3. VM 초기 설정
```bash
# SSH 접속
ssh -i <private_key> ubuntu@<VM_PUBLIC_IP>

# 시스템 업데이트
sudo apt update && sudo apt upgrade -y

# Docker 설치
curl -fsSL https://get.docker.com | sudo sh
sudo usermod -aG docker $USER

# Docker Compose 설치
sudo apt install docker-compose-plugin -y

# 재접속 (docker 그룹 적용)
exit
ssh -i <private_key> ubuntu@<VM_PUBLIC_IP>

# Docker 확인
docker --version
docker compose version
```

---

### Phase 3: DB + 백엔드 배포

#### 3-1. 프로젝트 클론 및 환경 설정
```bash
# 프로젝트 클론
git clone https://github.com/Meteor-Simulation/BulCHomepage.git
cd BulCHomepage

# 프로덕션 환경변수 파일 생성
cp .env.prod.example .env.prod
```

#### 3-2. `.env.prod` 설정
```env
# === Database ===
DB_NAME=bulc_homepage_db
DB_USER=bulc_prod_user
DB_PASSWORD=<강력한_비밀번호_생성>

# === Server ===
BACKEND_PORT=8080
SERVER_URL=https://api.msimul.com

# === JWT ===
JWT_SECRET=<openssl rand -base64 64 결과값>
JWT_ACCESS_EXPIRATION=600000
JWT_REFRESH_EXPIRATION=604800000

# === OAuth2 ===
NAVER_CLIENT_ID=<프로덕션_네이버_클라이언트_ID>
NAVER_CLIENT_SECRET=<프로덕션_네이버_시크릿>
KAKAO_CLIENT_ID=<프로덕션_카카오_클라이언트_ID>
KAKAO_CLIENT_SECRET=<프로덕션_카카오_시크릿>
GOOGLE_CLIENT_ID=<프로덕션_구글_클라이언트_ID>
GOOGLE_CLIENT_SECRET=<프로덕션_구글_시크릿>

OAUTH2_CALLBACK_BASE_URL=https://api.msimul.com
OAUTH2_REDIRECT_URI=https://bulc.msimul.com/oauth/callback

# === Licensing ===
LIC_PRIVATE_KEY_PATH=/run/secrets/session_token_private_key.pem

# === Toss Payments ===
TOSS_CLIENT_KEY=<프로덕션_토스_클라이언트_키>
TOSS_SECRET_KEY=<프로덕션_토스_시크릿_키>
TOSS_SUCCESS_URL=https://bulc.msimul.com/payment/success
TOSS_FAIL_URL=https://bulc.msimul.com/payment/fail

# === Microsoft Graph Mail ===
MS_TENANT_ID=<프로덕션_테넌트_ID>
MS_CLIENT_ID=<프로덕션_클라이언트_ID>
MS_CLIENT_SECRET=<프로덕션_시크릿>
MAIL_FROM=noreply@msimul.com
MAIL_FROM_ACCOUNTS=accounts@msimul.com
MAIL_FROM_BILLING=billing@msimul.com
MAIL_REPLY_TO=support@msimul.com

# === CORS ===
CORS_ALLOWED_ORIGINS=https://bulc.msimul.com
```

#### 3-3. secrets 디렉토리 준비
```bash
mkdir -p secrets
# 로컬에서 서버로 복사
scp -i <private_key> session_token_private_key.pem ubuntu@<VM_IP>:~/BulCHomepage/secrets/
```

#### 3-4. Nginx 리버스 프록시 + SSL 설정
```bash
# Nginx 설치
sudo apt install nginx certbot python3-certbot-nginx -y

# SSL 인증서 발급 (도메인 DNS가 VM IP를 가리키고 있어야 함)
sudo certbot --nginx -d api.msimul.com
```

Nginx 설정 (`/etc/nginx/sites-available/api.msimul.com`):
```nginx
server {
    listen 443 ssl;
    server_name api.msimul.com;

    ssl_certificate /etc/letsencrypt/live/api.msimul.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.msimul.com/privkey.pem;

    # 프론트엔드 CORS 허용을 위한 헤더
    add_header Access-Control-Allow-Origin "https://bulc.msimul.com" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    add_header Access-Control-Allow-Credentials "true" always;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # OPTIONS 프리플라이트 처리
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
}

server {
    listen 80;
    server_name api.msimul.com;
    return 301 https://$host$request_uri;
}
```

```bash
sudo ln -s /etc/nginx/sites-available/api.msimul.com /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# SSL 자동 갱신 확인
sudo certbot renew --dry-run
```

#### 3-5. Docker Compose로 백엔드 + DB 실행
```bash
cd ~/BulCHomepage

# docker-compose.prod.yml 에서 frontend 서비스와 ports 제거 후 사용
# (프론트는 Cloudflare에서 서빙하므로 서버에서 실행 불필요)
docker compose -f docker-compose.prod.yml --env-file .env.prod up -d database backend
```

#### 3-6. 동작 확인
```bash
# 컨테이너 상태
docker compose -f docker-compose.prod.yml ps

# 백엔드 헬스체크
curl http://localhost:8080/api/health

# 외부에서 확인
curl https://api.msimul.com/api/health
```

---

### Phase 4: 프론트엔드 배포 (Cloudflare Pages)

#### 4-1. Cloudflare Pages 프로젝트 생성
1. Cloudflare 대시보드 > **Workers & Pages** > **Create**
2. **Connect to Git** > GitHub 계정 연동
3. 레포지토리 선택: `Meteor-Simulation/BulCHomepage`

#### 4-2. 빌드 설정
| 항목 | 값 |
|------|-----|
| Production branch | `main` |
| Build command | `npm run build` |
| Build output directory | `build` |
| Root directory | `frontend` |

#### 4-3. 환경변수 설정
Cloudflare Pages > Settings > Environment variables:

| 변수명 | 값 |
|--------|-----|
| `REACT_APP_API_URL` | `https://api.msimul.com` |
| `NODE_VERSION` | `20` |

#### 4-4. SPA 라우팅 설정
`frontend/public/_redirects` 파일 생성 (React Router 지원):
```
/*    /index.html   200
```
> 이 파일이 없으면 새로고침 시 404 에러 발생

#### 4-5. 커스텀 도메인 연결
1. Cloudflare Pages > Custom domains > Add
2. `bulc.msimul.com` 입력
3. Cloudflare가 자동으로 DNS CNAME 레코드 생성
4. HTTPS 자동 적용

#### 4-6. 배포 확인
- `https://bulc.msimul.com` 접속
- 로그인, API 호출 정상 동작 확인
- 브라우저 개발자 도구 > Network 탭에서 API 요청이 `api.msimul.com`으로 가는지 확인

---

### Phase 5: 배포 후 점검

#### 5-1. 필수 확인 항목
- [ ] HTTPS 정상 동작 (프론트 + 백엔드 모두)
- [ ] API CORS 정상 (프론트에서 백엔드 API 호출)
- [ ] 회원가입 / 로그인 동작
- [ ] OAuth 소셜 로그인 (Google, Kakao, Naver) - 각 개발자 콘솔에서 리다이렉트 URI 업데이트 필수
- [ ] 결제 (토스페이먼츠) - 프로덕션 키 적용
- [ ] 이메일 발송 (Microsoft Graph)
- [ ] 라이선스 발급/검증

#### 5-2. OAuth 리다이렉트 URI 업데이트
각 소셜 로그인 개발자 콘솔에서 아래 URI 등록:

| 플랫폼 | 콜백 URI |
|--------|----------|
| Google | `https://api.msimul.com/api/auth/oauth2/callback/google` |
| Kakao | `https://api.msimul.com/api/auth/oauth2/callback/kakao` |
| Naver | `https://api.msimul.com/api/auth/oauth2/callback/naver` |

프론트엔드 리다이렉트 URI:
```
https://bulc.msimul.com/oauth/callback
```

#### 5-3. 모니터링 설정 (선택)
```bash
# Docker 로그 확인
docker logs -f bulc-backend-prod
docker logs -f bulc-db-prod

# 디스크 사용량 모니터링
df -h

# Docker 리소스 모니터링
docker stats
```

---

## 백엔드 CORS 설정 변경 필요

Spring Boot에서 프로덕션 도메인의 CORS를 허용해야 합니다.
`application.yml`의 prod 프로필에 CORS 설정을 추가하거나,
Spring Security 설정에서 `CORS_ALLOWED_ORIGINS` 환경변수를 읽도록 수정이 필요합니다.

```
허용 Origin: https://bulc.msimul.com
허용 Methods: GET, POST, PUT, DELETE, OPTIONS
허용 Headers: Authorization, Content-Type
Credentials: true
```

---

## 비용 요약

| 서비스 | 월 비용 | 비고 |
|--------|---------|------|
| **Cloudflare Pages** | **무료** | 대역폭 무제한, 빌드 500회/월 |
| **Oracle Cloud VM** | **무료** | Always Free (ARM 4 OCPU, 24GB RAM) |
| **도메인** | ~연 1~2만원 | 이미 보유 시 무료 |
| **합계** | **월 0원** | 도메인 비용 제외 |

---

## 주의사항

1. **`.env.prod` 파일은 절대 Git에 커밋하지 마세요** - `.gitignore`에 포함 확인
2. **DB 포트(5432)를 외부에 열지 마세요** - 백엔드에서 내부 접근만 허용
3. **SSL 인증서 자동 갱신** - certbot의 cron job 확인 (`sudo certbot renew --dry-run`)
4. **백업** - PostgreSQL 정기 백업 스크립트 설정 권장
   ```bash
   # 매일 자동 백업 (crontab에 추가)
   0 3 * * * docker exec bulc-db-prod pg_dump -U $DB_USER $DB_NAME | gzip > ~/backups/db_$(date +\%Y\%m\%d).sql.gz
   ```
5. **Oracle Cloud VM은 90일 idle 시 회수될 수 있음** - 주기적 사용 또는 모니터링 필요
