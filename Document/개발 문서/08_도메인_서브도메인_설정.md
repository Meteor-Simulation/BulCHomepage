# 도메인 및 서브도메인 설정 가이드

## 목표

각 카테고리 페이지를 독립된 서브도메인으로 운영:

| 서브도메인 | 페이지 |
|-----------|--------|
| `meteor.msimul.com` | METEOR 페이지 |
| `bulc.msimul.com` | BUL:C 페이지 |
| `vr.msimul.com` | VR 페이지 |

---

## 1. 로컬 테스트 환경 설정

### Windows hosts 파일 수정

1. 관리자 권한으로 메모장 실행
2. 파일 열기: `C:\Windows\System32\drivers\etc\hosts`
3. 아래 내용 추가:

```
127.0.0.1 meteor.localhost
127.0.0.1 bulc.localhost
127.0.0.1 vr.localhost
127.0.0.1 msimul.localhost
```

또는 실제 도메인으로 테스트하려면:

```
127.0.0.1 meteor.msimul.com
127.0.0.1 bulc.msimul.com
127.0.0.1 vr.msimul.com
```

4. 저장 후 브라우저에서 `http://meteor.localhost:3000` 접속

> **참고**: `.localhost` 도메인은 hosts 파일 수정 없이도 127.0.0.1로 자동 연결되는 브라우저도 있음 (Chrome 등)

---

## 2. React 앱 수정

### 서브도메인 감지 유틸리티 생성

`src/utils/subdomain.ts`:

```typescript
export type SubdomainType = 'meteor' | 'bulc' | 'vr' | 'main';

export const getSubdomain = (): SubdomainType => {
  const hostname = window.location.hostname;

  // localhost 환경: meteor.localhost, bulc.localhost 등
  // 운영 환경: meteor.msimul.com, bulc.msimul.com 등
  const subdomain = hostname.split('.')[0].toLowerCase();

  if (subdomain === 'meteor') return 'meteor';
  if (subdomain === 'bulc') return 'bulc';
  if (subdomain === 'vr') return 'vr';

  return 'main';
};

export const isSubdomainAccess = (): boolean => {
  return getSubdomain() !== 'main';
};
```

### index.tsx 수정

```typescript
import { getSubdomain, SubdomainType } from './utils/subdomain';

const App: React.FC = () => {
  const subdomain = getSubdomain();

  // 서브도메인으로 접속 시 해당 페이지만 표시
  const getDefaultRoute = () => {
    switch (subdomain) {
      case 'meteor': return <MeteorPage />;
      case 'bulc': return <BulCPage />;
      case 'vr': return <VRPage />;
      default: return <MainPage />;  // 또는 리다이렉트
    }
  };

  return (
    <ErrorBoundary>
      <AuthProvider>
        <BrowserRouter>
          <Routes>
            {/* 서브도메인 접속 시 루트 경로에서 해당 카테고리 표시 */}
            <Route path="/" element={getDefaultRoute()} />

            {/* 공통 라우트 */}
            <Route path="/payment" element={<PaymentPage />} />
            <Route path="/payment/success" element={<PaymentSuccess />} />
            <Route path="/payment/fail" element={<PaymentFail />} />
            <Route path="/mypage" element={<MyPage />} />
            <Route path="/admin" element={<AdminPage />} />
            <Route path="/oauth/callback" element={<OAuthCallback />} />
            <Route path="/oauth/setup-password" element={<OAuthSetupPassword />} />
            <Route path="/error" element={<ErrorPage />} />
            <Route path="*" element={<NotFoundPage />} />
          </Routes>
        </BrowserRouter>
      </AuthProvider>
    </ErrorBoundary>
  );
};
```

### 로고 클릭 동작 수정

각 카테고리 페이지에서 로고 클릭 시 해당 카테고리의 Intro로 이동:

```typescript
// Header.tsx 또는 각 페이지에서
const handleLogoClick = () => {
  // 서브도메인 환경: 현재 페이지의 Intro로
  // 일반 환경: 메인 페이지로
  if (isSubdomainAccess()) {
    setActiveMenu('intro');  // 첫 메뉴로 이동
  } else {
    navigate('/');
  }
};
```

---

## 3. Nginx 설정 (운영 환경)

### docker-compose.prod.yml 또는 nginx.conf

```nginx
# HTTP to HTTPS 리다이렉트
server {
    listen 80;
    server_name meteor.msimul.com bulc.msimul.com vr.msimul.com msimul.com;
    return 301 https://$server_name$request_uri;
}

# METEOR 서브도메인
server {
    listen 443 ssl;
    server_name meteor.msimul.com;

    ssl_certificate /etc/nginx/ssl/msimul.com.crt;
    ssl_certificate_key /etc/nginx/ssl/msimul.com.key;

    location / {
        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# BULC 서브도메인
server {
    listen 443 ssl;
    server_name bulc.msimul.com;

    ssl_certificate /etc/nginx/ssl/msimul.com.crt;
    ssl_certificate_key /etc/nginx/ssl/msimul.com.key;

    location / {
        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# VR 서브도메인
server {
    listen 443 ssl;
    server_name vr.msimul.com;

    ssl_certificate /etc/nginx/ssl/msimul.com.crt;
    ssl_certificate_key /etc/nginx/ssl/msimul.com.key;

    location / {
        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 메인 도메인 (선택적)
server {
    listen 443 ssl;
    server_name msimul.com www.msimul.com;

    ssl_certificate /etc/nginx/ssl/msimul.com.crt;
    ssl_certificate_key /etc/nginx/ssl/msimul.com.key;

    # 옵션 1: 특정 서브도메인으로 리다이렉트
    # return 301 https://bulc.msimul.com$request_uri;

    # 옵션 2: 카테고리 선택 페이지 표시
    location / {
        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 4. DNS 설정 (도메인 관리자)

도메인 관리 사이트(가비아, 카페24 등)에서 설정:

### A 레코드 추가

| 호스트 | 타입 | 값 |
|--------|------|-----|
| meteor | A | 서버 IP |
| bulc | A | 서버 IP |
| vr | A | 서버 IP |

### 또는 와일드카드

| 호스트 | 타입 | 값 |
|--------|------|-----|
| * | A | 서버 IP |

> **SSL 인증서**: 와일드카드 인증서(`*.msimul.com`) 사용 권장

---

## 5. 테스트 체크리스트

### 로컬 테스트

- [ ] `http://meteor.localhost:3000` 접속 → METEOR 페이지 표시
- [ ] `http://bulc.localhost:3000` 접속 → BUL:C 페이지 표시
- [ ] `http://vr.localhost:3000` 접속 → VR 페이지 표시
- [ ] 각 페이지에서 로고 클릭 → Intro 메뉴로 이동
- [ ] 로그인/결제 등 공통 기능 정상 동작

### 운영 테스트

- [ ] DNS 전파 확인 (`nslookup meteor.msimul.com`)
- [ ] HTTPS 인증서 정상 적용
- [ ] 각 서브도메인 접속 확인
- [ ] API 호출 정상 동작 (CORS 확인)

---

## 6. 주의사항

### CORS 설정

백엔드에서 모든 서브도메인 허용 필요:

```java
// SecurityConfig.java 또는 WebConfig.java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.setAllowedOrigins(Arrays.asList(
        "https://msimul.com",
        "https://meteor.msimul.com",
        "https://bulc.msimul.com",
        "https://vr.msimul.com",
        "http://localhost:3000",
        "http://meteor.localhost:3000",
        "http://bulc.localhost:3000",
        "http://vr.localhost:3000"
    ));
    // ... 나머지 설정
}
```

### 쿠키 도메인

로그인 세션 공유를 위해 쿠키 도메인 설정:

```java
// 쿠키 생성 시
cookie.setDomain(".msimul.com");  // 모든 서브도메인에서 공유
```

---

## 작업 순서 요약

1. **로컬 테스트 환경 설정** - hosts 파일 수정
2. **React 앱 수정** - 서브도메인 감지 로직 추가
3. **로컬 테스트** - 브라우저에서 확인
4. **DNS 설정** - 도메인 관리자에서 서브도메인 추가
5. **Nginx 설정** - 서버 설정 수정
6. **운영 배포 및 테스트**
