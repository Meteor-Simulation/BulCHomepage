# BulC Homepage 기능별 흐름도

| 항목 | 내용 |
|------|------|
| 문서 버전 | v1.0 |
| 작성일 | 2026-01-19 |
| 프로젝트명 | BulC Homepage |

---

## 1. 회원가입 / 로그인 / 로그아웃

### 1.1 개요

JWT 기반 인증 시스템으로, Access Token(1시간)과 Refresh Token(30일)을 사용합니다.
RTR(Refresh Token Rotation) 정책을 적용하여 토큰 갱신 시 새로운 Refresh Token을 발급합니다.

### 1.2 일반 회원가입 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              일반 회원가입 흐름                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [사용자]                    [Frontend]                    [Backend]             │
│     │                           │                             │                  │
│     │  1. 회원가입 버튼 클릭     │                             │                  │
│     │─────────────────────────>│                             │                  │
│     │                          │                             │                  │
│     │  2. SignupModal 표시     │                             │                  │
│     │<─────────────────────────│                             │                  │
│     │                          │                             │                  │
│     │  3. 폼 입력               │                             │                  │
│     │   - 이메일                │                             │                  │
│     │   - 비밀번호              │                             │                  │
│     │   - 이름                  │                             │                  │
│     │   - 전화번호              │                             │                  │
│     │─────────────────────────>│                             │                  │
│     │                          │                             │                  │
│     │                          │  4. 이메일 중복 검사          │                  │
│     │                          │    POST /api/auth/check-email│                 │
│     │                          │─────────────────────────────>│                  │
│     │                          │                             │                  │
│     │                          │  5. 중복 여부 응답           │                  │
│     │                          │<─────────────────────────────│                  │
│     │                          │                             │                  │
│     │                          │  6. 회원가입 요청            │                  │
│     │                          │    POST /api/auth/signup     │                  │
│     │                          │─────────────────────────────>│                  │
│     │                          │                             │                  │
│     │                          │                             │  7. 비밀번호 암호화│
│     │                          │                             │    BCrypt 해싱    │
│     │                          │                             │                  │
│     │                          │                             │  8. users 테이블  │
│     │                          │                             │    INSERT        │
│     │                          │                             │                  │
│     │                          │  9. JWT 토큰 발급            │                  │
│     │                          │   - accessToken (1h)         │                  │
│     │                          │   - refreshToken (30d)       │                  │
│     │                          │<─────────────────────────────│                  │
│     │                          │                             │                  │
│     │                          │ 10. localStorage 저장        │                  │
│     │                          │   - accessToken              │                  │
│     │                          │   - refreshToken             │                  │
│     │                          │   - user 정보                │                  │
│     │                          │                             │                  │
│     │ 11. 로그인 완료 처리      │                             │                  │
│     │<─────────────────────────│                             │                  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/components/SignupModal.tsx` | `handleSubmit()` :140-197 |
| Frontend | `src/context/AuthContext.tsx` | `login()` :184-229 |
| Frontend | `src/utils/api.ts` | `getApiBaseUrl()` :7-11 |
| Backend | `controller/AuthController.java` | `signup()` :72-92 |
| Backend | `service/AuthService.java` | `register()` :56-95 |
| Backend | `util/JwtTokenProvider.java` | `createAccessToken()` :45-67 |
| Database | `init.sql` | `users` 테이블 정의 |

---

### 1.3 OAuth 소셜 로그인 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              OAuth 소셜 로그인 흐름                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [사용자]      [Frontend]        [Backend]        [OAuth Provider]              │
│     │             │                 │                   │                        │
│     │  1. 소셜 로그인 버튼 클릭     │                   │                        │
│     │   (네이버/카카오/구글)        │                   │                        │
│     │────────────>│                 │                   │                        │
│     │             │                 │                   │                        │
│     │             │  2. OAuth 인증 URL 요청              │                       │
│     │             │    GET /api/oauth/{provider}        │                        │
│     │             │────────────────>│                   │                        │
│     │             │                 │                   │                        │
│     │             │  3. 리다이렉트 URL 반환              │                        │
│     │             │<────────────────│                   │                        │
│     │             │                 │                   │                        │
│     │  4. OAuth Provider로 리다이렉트                    │                       │
│     │<────────────│                 │                   │                        │
│     │             │                 │                   │                        │
│     │  5. 소셜 로그인 진행          │                   │                        │
│     │─────────────────────────────────────────────────>│                        │
│     │             │                 │                   │                        │
│     │  6. 인증 코드와 함께 콜백     │                   │                        │
│     │<─────────────────────────────────────────────────│                        │
│     │             │                 │                   │                        │
│     │             │  7. 콜백 처리                       │                        │
│     │             │    GET /api/oauth/{provider}/callback?code=xxx               │
│     │             │────────────────>│                   │                        │
│     │             │                 │                   │                        │
│     │             │                 │  8. Access Token 요청                     │
│     │             │                 │──────────────────>│                        │
│     │             │                 │                   │                        │
│     │             │                 │  9. Access Token 반환                     │
│     │             │                 │<──────────────────│                        │
│     │             │                 │                   │                        │
│     │             │                 │ 10. 사용자 정보 요청                       │
│     │             │                 │──────────────────>│                        │
│     │             │                 │                   │                        │
│     │             │                 │ 11. 사용자 정보 반환                       │
│     │             │                 │<──────────────────│                        │
│     │             │                 │                   │                        │
│     │             │                 │ 12. 기존 회원 확인                        │
│     │             │                 │   - 이메일로 users 조회                   │
│     │             │                 │                   │                        │
│     │             │                 │ [기존 회원인 경우]                        │
│     │             │                 │   → JWT 발급 후 홈으로 리다이렉트          │
│     │             │                 │                   │                        │
│     │             │                 │ [신규 회원인 경우]                        │
│     │             │                 │   → 임시토큰 발급                         │
│     │             │                 │   → /oauth/setup-password로 리다이렉트    │
│     │             │                 │                   │                        │
│     │ 13. 비밀번호 설정 페이지 표시 │                   │                        │
│     │   (신규 회원만)              │                   │                        │
│     │<────────────│                 │                   │                        │
│     │             │                 │                   │                        │
│     │ 14. 비밀번호 입력 및 제출     │                   │                        │
│     │────────────>│                 │                   │                        │
│     │             │                 │                   │                        │
│     │             │ 15. 회원가입 완료 요청               │                       │
│     │             │    POST /api/auth/oauth/signup       │                       │
│     │             │────────────────>│                   │                        │
│     │             │                 │                   │                        │
│     │             │ 16. JWT 토큰 반환                    │                       │
│     │             │<────────────────│                   │                        │
│     │             │                 │                   │                        │
│     │ 17. 로그인 완료               │                   │                        │
│     │<────────────│                 │                   │                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/components/LoginModal.tsx` | `handleSocialLogin()` :88-95 |
| Frontend | `src/pages/OAuthSetupPassword.tsx` | `handleSubmit()` :44-96 |
| Backend | `controller/OAuthController.java` | `getAuthorizationUrl()`, `handleCallback()` |
| Backend | `service/OAuthService.java` | `processOAuthLogin()` |
| Backend | `service/NaverOAuthService.java` | 네이버 OAuth 처리 |
| Backend | `service/KakaoOAuthService.java` | 카카오 OAuth 처리 |

---

### 1.4 로그인 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 로그인 흐름                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [사용자]                    [Frontend]                    [Backend]             │
│     │                           │                             │                  │
│     │  1. 이메일/비밀번호 입력   │                             │                  │
│     │─────────────────────────>│                             │                  │
│     │                          │                             │                  │
│     │                          │  2. 로그인 요청              │                  │
│     │                          │    POST /api/auth/login      │                  │
│     │                          │─────────────────────────────>│                  │
│     │                          │                             │                  │
│     │                          │                             │  3. 이메일로 사용자│
│     │                          │                             │    조회          │
│     │                          │                             │                  │
│     │                          │                             │  4. 비밀번호 검증 │
│     │                          │                             │    BCrypt.matches │
│     │                          │                             │                  │
│     │                          │                             │  5. JWT 토큰 생성 │
│     │                          │                             │   - accessToken  │
│     │                          │                             │   - refreshToken │
│     │                          │                             │                  │
│     │                          │  6. 토큰 및 사용자 정보 반환  │                  │
│     │                          │<─────────────────────────────│                  │
│     │                          │                             │                  │
│     │                          │  7. AuthContext 상태 업데이트 │                  │
│     │                          │   - setUser(userData)        │                  │
│     │                          │   - localStorage 저장        │                  │
│     │                          │                             │                  │
│     │  8. 로그인 완료 (모달 닫힘)│                             │                  │
│     │<─────────────────────────│                             │                  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/components/LoginModal.tsx` | `handleSubmit()` :54-86 |
| Frontend | `src/context/AuthContext.tsx` | `login()` :184-229 |
| Backend | `controller/AuthController.java` | `login()` :94-108 |
| Backend | `service/AuthService.java` | `login()` :97-130 |
| Backend | `util/JwtTokenProvider.java` | `createAccessToken()`, `createRefreshToken()` |

---

### 1.5 로그아웃 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 로그아웃 흐름                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [사용자]                    [Frontend]                    [Backend]             │
│     │                           │                             │                  │
│     │  1. 로그아웃 버튼 클릭     │                             │                  │
│     │─────────────────────────>│                             │                  │
│     │                          │                             │                  │
│     │                          │  2. 로그아웃 API 호출        │                  │
│     │                          │    POST /api/auth/logout     │                  │
│     │                          │    Authorization: Bearer xxx  │                  │
│     │                          │─────────────────────────────>│                  │
│     │                          │                             │                  │
│     │                          │                             │  3. 토큰 블랙리스트│
│     │                          │                             │    등록 (선택적) │
│     │                          │                             │                  │
│     │                          │  4. 로그아웃 완료 응답       │                  │
│     │                          │<─────────────────────────────│                  │
│     │                          │                             │                  │
│     │                          │  5. 로컬 상태 정리           │                  │
│     │                          │   - setUser(null)            │                  │
│     │                          │   - localStorage.clear()     │                  │
│     │                          │                             │                  │
│     │  6. 로그아웃 완료 (홈으로) │                             │                  │
│     │<─────────────────────────│                             │                  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/context/AuthContext.tsx` | `logout()` :57-80 |
| Frontend | `src/components/Header.tsx` | 로그아웃 버튼 onClick |
| Backend | `controller/AuthController.java` | `logout()` |

---

### 1.6 토큰 갱신 흐름 (자동)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              토큰 자동 갱신 흐름                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [Frontend - useEffect]              [Backend]                                  │
│           │                              │                                       │
│           │  1. 1초마다 세션 체크         │                                       │
│           │    checkSession()            │                                       │
│           │                              │                                       │
│           │  2. tokenExpiration 확인     │                                       │
│           │    - 남은 시간 계산          │                                       │
│           │                              │                                       │
│           │  [만료됨 또는 1분 이하 남음]  │                                       │
│           │                              │                                       │
│           │  3. 토큰 갱신 요청           │                                       │
│           │    POST /api/auth/refresh    │                                       │
│           │    { refreshToken: xxx }     │                                       │
│           │─────────────────────────────>│                                       │
│           │                              │                                       │
│           │                              │  4. Refresh Token 검증                │
│           │                              │    - 유효성 확인                      │
│           │                              │    - 블랙리스트 확인                  │
│           │                              │                                       │
│           │                              │  5. 새 토큰 쌍 발급 (RTR)             │
│           │                              │    - 새 accessToken                   │
│           │                              │    - 새 refreshToken                  │
│           │                              │                                       │
│           │  6. 새 토큰 반환             │                                       │
│           │<─────────────────────────────│                                       │
│           │                              │                                       │
│           │  7. localStorage 업데이트    │                                       │
│           │    - 새 accessToken 저장     │                                       │
│           │    - 새 refreshToken 저장    │                                       │
│           │    - 새 tokenExpiration 저장 │                                       │
│           │                              │                                       │
│           │  [갱신 실패 시]              │                                       │
│           │    - alert('세션 만료')       │                                       │
│           │    - logout() 호출           │                                       │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/context/AuthContext.tsx` | `refreshAccessToken()` :83-118 |
| Frontend | `src/context/AuthContext.tsx` | `useEffect (checkSession)` :121-154 |
| Backend | `controller/AuthController.java` | `refresh()` |
| Backend | `service/AuthService.java` | `refreshToken()` |

---

## 2. 결제 시스템

### 2.1 개요

토스페이먼츠 API를 사용한 결제 시스템입니다.
일반 결제, 가상계좌, 구독 빌링(자동결제)를 지원합니다.

### 2.2 일반 결제 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              일반 결제 흐름                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [사용자]       [Frontend]         [Backend]         [TossPayments]             │
│     │              │                  │                    │                     │
│     │  1. 상품 선택 │                  │                    │                     │
│     │   (라이선스)  │                  │                    │                     │
│     │─────────────>│                  │                    │                     │
│     │              │                  │                    │                     │
│     │              │  2. Payment.tsx 렌더링                 │                     │
│     │              │   - 가격 정보 표시                     │                     │
│     │              │   - 결제 버튼 준비                     │                     │
│     │              │                  │                    │                     │
│     │  3. 결제하기 버튼 클릭           │                    │                     │
│     │─────────────>│                  │                    │                     │
│     │              │                  │                    │                     │
│     │              │  4. 주문 생성 요청│                    │                     │
│     │              │    POST /api/payments/ready            │                    │
│     │              │─────────────────>│                    │                     │
│     │              │                  │                    │                     │
│     │              │                  │  5. orders 테이블   │                     │
│     │              │                  │    INSERT          │                     │
│     │              │                  │   - orderId 생성   │                     │
│     │              │                  │   - status: PENDING│                     │
│     │              │                  │                    │                     │
│     │              │  6. orderId 반환 │                    │                     │
│     │              │<─────────────────│                    │                     │
│     │              │                  │                    │                     │
│     │              │  7. TossPayments SDK 호출              │                     │
│     │              │    requestPayment({                    │                     │
│     │              │      orderId,                          │                     │
│     │              │      amount,                           │                     │
│     │              │      orderName                         │                     │
│     │              │    })                                  │                     │
│     │              │────────────────────────────────────────>│                    │
│     │              │                  │                    │                     │
│     │  8. 결제창 표시                  │                    │                     │
│     │<─────────────│                  │                    │                     │
│     │              │                  │                    │                     │
│     │  9. 카드/계좌 정보 입력          │                    │                     │
│     │              │                  │                    │                     │
│     │ 10. 결제 완료 │                  │                    │                     │
│     │              │                  │                    │                     │
│     │              │ 11. 성공 콜백 (paymentKey, orderId, amount)                 │
│     │              │<────────────────────────────────────────│                    │
│     │              │                  │                    │                     │
│     │              │ 12. 결제 승인 요청│                    │                     │
│     │              │   POST /api/payments/confirm            │                    │
│     │              │   { paymentKey, orderId, amount }       │                    │
│     │              │─────────────────>│                    │                     │
│     │              │                  │                    │                     │
│     │              │                  │ 13. 결제 승인 API 호출                   │
│     │              │                  │   POST /v1/payments/confirm              │
│     │              │                  │─────────────────────>│                    │
│     │              │                  │                    │                     │
│     │              │                  │ 14. 승인 결과 반환 │                     │
│     │              │                  │<─────────────────────│                    │
│     │              │                  │                    │                     │
│     │              │                  │ 15. orders 테이블 UPDATE                 │
│     │              │                  │   - status: COMPLETED                    │
│     │              │                  │   - paymentKey 저장                      │
│     │              │                  │                    │                     │
│     │              │                  │ 16. 라이선스 발급   │                     │
│     │              │                  │   licenseService.issueLicenseWithPlan()  │
│     │              │                  │                    │                     │
│     │              │ 17. 결제 완료 응답│                    │                     │
│     │              │<─────────────────│                    │                     │
│     │              │                  │                    │                     │
│     │ 18. 결제 완료 화면 표시          │                    │                     │
│     │<─────────────│                  │                    │                     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/pages/Payment.tsx` | `handlePayment()` |
| Frontend | `src/pages/Payment.tsx` | TossPayments SDK 초기화 |
| Backend | `controller/PaymentController.java` | `readyPayment()`, `confirmPayment()` |
| Backend | `service/PaymentService.java` | `createOrder()`, `confirmPayment()` |
| Backend | `service/TossPaymentClient.java` | `confirmPayment()` - Toss API 호출 |
| Backend | `licensing/service/LicenseService.java` | `issueLicenseWithPlan()` |

---

### 2.3 가상계좌 결제 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              가상계좌 결제 흐름                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [사용자]       [Frontend]         [Backend]         [TossPayments]             │
│     │              │                  │                    │                     │
│     │  1. 가상계좌 결제 선택          │                    │                     │
│     │─────────────>│                  │                    │                     │
│     │              │                  │                    │                     │
│     │              │  2. 가상계좌 발급 요청                 │                     │
│     │              │   requestPayment({                     │                     │
│     │              │     method: "가상계좌",                │                     │
│     │              │     validHours: 24                     │                     │
│     │              │   })                                   │                     │
│     │              │─────────────────────────────────────────>│                   │
│     │              │                  │                    │                     │
│     │              │  3. 가상계좌 정보 콜백                  │                     │
│     │              │   - 은행명, 계좌번호                   │                     │
│     │              │   - 입금 기한                          │                     │
│     │              │<─────────────────────────────────────────│                   │
│     │              │                  │                    │                     │
│     │  4. 가상계좌 정보 표시           │                    │                     │
│     │<─────────────│                  │                    │                     │
│     │              │                  │                    │                     │
│     │  5. 입금 (은행 앱 등)            │                    │                     │
│     │              │                  │                    │                     │
│     │              │                  │                    │                     │
│     │              │                  │  6. 입금 완료 웹훅   │                    │
│     │              │                  │   POST /api/payments/webhook             │
│     │              │                  │   (TossPayments → Backend)               │
│     │              │                  │<─────────────────────│                    │
│     │              │                  │                    │                     │
│     │              │                  │  7. orders UPDATE   │                     │
│     │              │                  │    status: COMPLETED│                     │
│     │              │                  │                    │                     │
│     │              │                  │  8. 라이선스 발급   │                     │
│     │              │                  │                    │                     │
│     │  [이메일/알림 수신]              │                    │                     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/pages/Payment.tsx` | 가상계좌 관련 로직 |
| Backend | `controller/PaymentController.java` | `handleWebhook()` |
| Backend | `service/PaymentService.java` | `processVirtualAccountDeposit()` |

---

### 2.4 구독 빌링 (자동결제) 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              구독 빌링 흐름                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [사용자]       [Frontend]         [Backend]         [TossPayments]             │
│     │              │                  │                    │                     │
│     │  === 최초 카드 등록 ===          │                    │                     │
│     │              │                  │                    │                     │
│     │  1. 구독 결제 선택               │                    │                     │
│     │─────────────>│                  │                    │                     │
│     │              │                  │                    │                     │
│     │              │  2. 빌링키 발급 요청                   │                     │
│     │              │   requestBillingAuth()                 │                    │
│     │              │────────────────────────────────────────>│                    │
│     │              │                  │                    │                     │
│     │  3. 카드 정보 입력               │                    │                     │
│     │              │                  │                    │                     │
│     │              │  4. authKey 콜백  │                    │                     │
│     │              │<────────────────────────────────────────│                    │
│     │              │                  │                    │                     │
│     │              │  5. 빌링키 확정 요청                   │                    │
│     │              │   POST /api/billing/issue              │                    │
│     │              │   { authKey, customerKey }             │                    │
│     │              │─────────────────>│                    │                     │
│     │              │                  │                    │                     │
│     │              │                  │  6. 빌링키 발급 API│                     │
│     │              │                  │   POST /v1/billing/authorizations/issue  │
│     │              │                  │─────────────────────>│                    │
│     │              │                  │                    │                     │
│     │              │                  │  7. billingKey 반환 │                     │
│     │              │                  │<─────────────────────│                    │
│     │              │                  │                    │                     │
│     │              │                  │  8. billing_keys 테이블 저장             │
│     │              │                  │   - customerKey                          │
│     │              │                  │   - billingKey (암호화)                  │
│     │              │                  │   - cardInfo                             │
│     │              │                  │                    │                     │
│     │              │  9. 최초 결제 진행│                    │                     │
│     │              │   POST /api/billing/pay                │                    │
│     │              │─────────────────>│                    │                     │
│     │              │                  │                    │                     │
│     │              │                  │ 10. 빌링 결제 API  │                     │
│     │              │                  │   POST /v1/billing/{billingKey}          │
│     │              │                  │─────────────────────>│                    │
│     │              │                  │                    │                     │
│     │              │                  │ 11. 결제 결과      │                     │
│     │              │                  │<─────────────────────│                    │
│     │              │                  │                    │                     │
│     │              │                  │ 12. subscriptions 테이블 저장            │
│     │              │                  │   - 다음 결제일 설정                     │
│     │              │                  │   - status: ACTIVE                       │
│     │              │                  │                    │                     │
│     │ 13. 구독 완료│                  │                    │                     │
│     │<─────────────│                  │                    │                     │
│     │              │                  │                    │                     │
│     │  === 자동 갱신 (Scheduler) ===   │                    │                     │
│     │              │                  │                    │                     │
│     │              │                  │ 14. 매일 자정 실행 │                     │
│     │              │                  │   @Scheduled       │                     │
│     │              │                  │                    │                     │
│     │              │                  │ 15. 만료 예정 구독 조회                  │
│     │              │                  │   SELECT * FROM subscriptions            │
│     │              │                  │   WHERE next_payment_date <= today       │
│     │              │                  │                    │                     │
│     │              │                  │ 16. 자동 결제 실행 │                     │
│     │              │                  │   POST /v1/billing/{billingKey}          │
│     │              │                  │─────────────────────>│                    │
│     │              │                  │                    │                     │
│     │              │                  │ 17. 결제 결과      │                     │
│     │              │                  │<─────────────────────│                    │
│     │              │                  │                    │                     │
│     │              │                  │ 18. next_payment_date 갱신               │
│     │              │                  │   라이선스 기간 연장                     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/pages/Payment.tsx` | `handleBillingAuth()` |
| Backend | `controller/BillingController.java` | `issueBillingKey()`, `payWithBillingKey()` |
| Backend | `service/BillingService.java` | `issueBillingKey()`, `processAutoPayment()` |
| Backend | `scheduler/SubscriptionScheduler.java` | `processAutoRenewal()` |
| Database | `init.sql` | `billing_keys`, `subscriptions` 테이블 |

---

### 2.5 결제 취소/환불 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              결제 취소/환불 흐름                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [관리자]       [AdminPage]         [Backend]         [TossPayments]            │
│     │              │                  │                    │                     │
│     │  1. 환불 요청│                  │                    │                     │
│     │─────────────>│                  │                    │                     │
│     │              │                  │                    │                     │
│     │              │  2. 환불 API 요청│                    │                     │
│     │              │   POST /api/payments/cancel            │                    │
│     │              │   { paymentKey, cancelReason }         │                    │
│     │              │─────────────────>│                    │                     │
│     │              │                  │                    │                     │
│     │              │                  │  3. 취소 API 호출  │                     │
│     │              │                  │   POST /v1/payments/{paymentKey}/cancel  │
│     │              │                  │─────────────────────>│                    │
│     │              │                  │                    │                     │
│     │              │                  │  4. 취소 결과      │                     │
│     │              │                  │<─────────────────────│                    │
│     │              │                  │                    │                     │
│     │              │                  │  5. orders UPDATE   │                     │
│     │              │                  │   status: REFUNDED │                     │
│     │              │                  │                    │                     │
│     │              │                  │  6. 라이선스 취소   │                     │
│     │              │                  │   licenseService.revokeLicenseByOrderId()│
│     │              │                  │                    │                     │
│     │              │  7. 환불 완료 응답│                    │                     │
│     │              │<─────────────────│                    │                     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/pages/AdminPage.tsx` | 환불 처리 로직 |
| Backend | `controller/PaymentController.java` | `cancelPayment()` |
| Backend | `service/PaymentService.java` | `cancelPayment()` |
| Backend | `licensing/service/LicenseService.java` | `revokeLicenseByOrderId()` |

---

## 3. 관리자 페이지

### 3.1 개요

관리자/매니저 권한을 가진 사용자만 접근 가능한 관리 페이지입니다.
사용자 관리, 라이선스 관리, 결제 내역 관리 등의 기능을 제공합니다.

### 3.2 관리자 접근 권한 체크 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           관리자 접근 권한 체크 흐름                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [사용자]            [Frontend]                   [AuthContext]                 │
│     │                    │                            │                          │
│     │  1. /admin 접근    │                            │                          │
│     │───────────────────>│                            │                          │
│     │                    │                            │                          │
│     │                    │  2. isAuthReady 확인       │                          │
│     │                    │───────────────────────────>│                          │
│     │                    │                            │                          │
│     │                    │  [isAuthReady = false]     │                          │
│     │                    │   → 로딩 화면 표시         │                          │
│     │                    │                            │                          │
│     │                    │  [isAuthReady = true]      │                          │
│     │                    │   3. isAdmin 확인          │                          │
│     │                    │───────────────────────────>│                          │
│     │                    │                            │                          │
│     │                    │                            │  4. rolesCode 확인       │
│     │                    │                            │   - '000': admin         │
│     │                    │                            │   - '001': manager       │
│     │                    │                            │   - '002': user          │
│     │                    │                            │                          │
│     │                    │  5. isAdmin 반환           │                          │
│     │                    │<───────────────────────────│                          │
│     │                    │                            │                          │
│     │                    │  [isAdmin = false]         │                          │
│     │  6. 접근 거부      │   → "권한 없음" 표시       │                          │
│     │<───────────────────│   → 홈으로 리다이렉트      │                          │
│     │                    │                            │                          │
│     │                    │  [isAdmin = true]          │                          │
│     │  7. 관리자 페이지  │   → AdminPage 렌더링       │                          │
│     │<───────────────────│                            │                          │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/pages/AdminPage.tsx` | 권한 체크 로직 :35-55 |
| Frontend | `src/context/AuthContext.tsx` | `isAdmin` 계산 :285 |
| Frontend | `src/index.tsx` | `/admin` 라우트 정의 |

---

### 3.3 사용자 관리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              사용자 관리 흐름                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [관리자]           [AdminPage]              [Backend]                          │
│     │                   │                       │                                │
│     │  === 사용자 목록 조회 ===                 │                                │
│     │                   │                       │                                │
│     │  1. 페이지 진입    │                       │                                │
│     │──────────────────>│                       │                                │
│     │                   │                       │                                │
│     │                   │  2. 사용자 목록 요청   │                                │
│     │                   │   GET /api/admin/users │                               │
│     │                   │   ?page=0&size=20      │                               │
│     │                   │──────────────────────>│                                │
│     │                   │                       │                                │
│     │                   │                       │  3. 권한 검증                  │
│     │                   │                       │   @PreAuthorize("hasRole      │
│     │                   │                       │    ('ADMIN')")                │
│     │                   │                       │                                │
│     │                   │                       │  4. users 테이블 조회          │
│     │                   │                       │   SELECT * FROM users          │
│     │                   │                       │   ORDER BY created_at DESC     │
│     │                   │                       │                                │
│     │                   │  5. 사용자 목록 반환   │                                │
│     │                   │   { users, totalCount }│                               │
│     │                   │<──────────────────────│                                │
│     │                   │                       │                                │
│     │  6. 목록 표시     │                       │                                │
│     │<──────────────────│                       │                                │
│     │                   │                       │                                │
│     │  === 사용자 권한 변경 ===                 │                                │
│     │                   │                       │                                │
│     │  7. 권한 변경 선택│                       │                                │
│     │──────────────────>│                       │                                │
│     │                   │                       │                                │
│     │                   │  8. 권한 변경 요청     │                                │
│     │                   │   PUT /api/admin/users/{id}/role                       │
│     │                   │   { rolesCode: "001" } │                               │
│     │                   │──────────────────────>│                                │
│     │                   │                       │                                │
│     │                   │                       │  9. users UPDATE               │
│     │                   │                       │   SET roles_code = "001"       │
│     │                   │                       │                                │
│     │                   │ 10. 변경 완료 응답    │                                │
│     │                   │<──────────────────────│                                │
│     │                   │                       │                                │
│     │ 11. 목록 갱신     │                       │                                │
│     │<──────────────────│                       │                                │
│     │                   │                       │                                │
│     │  === 사용자 비활성화 ===                  │                                │
│     │                   │                       │                                │
│     │ 12. 비활성화 클릭 │                       │                                │
│     │──────────────────>│                       │                                │
│     │                   │                       │                                │
│     │                   │ 13. 비활성화 요청     │                                │
│     │                   │   DELETE /api/admin/users/{id}                         │
│     │                   │──────────────────────>│                                │
│     │                   │                       │                                │
│     │                   │                       │ 14. Soft Delete               │
│     │                   │                       │   SET is_active = false       │
│     │                   │                       │                                │
│     │                   │ 15. 완료 응답         │                                │
│     │                   │<──────────────────────│                                │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/pages/AdminPage.tsx` | `fetchUsers()`, `handleRoleChange()` |
| Backend | `controller/AdminController.java` | `getUsers()`, `updateUserRole()` |
| Backend | `service/AdminService.java` | `getAllUsers()`, `updateUserRole()` |
| Backend | `config/SecurityConfig.java` | 권한 검증 설정 |

---

### 3.4 라이선스 관리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              라이선스 관리 흐름                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [관리자]           [AdminPage]              [Backend]                          │
│     │                   │                       │                                │
│     │  === 라이선스 목록 조회 ===               │                                │
│     │                   │                       │                                │
│     │  1. 라이선스 탭 클릭                      │                                │
│     │──────────────────>│                       │                                │
│     │                   │                       │                                │
│     │                   │  2. 라이선스 목록 요청 │                               │
│     │                   │   GET /api/v1/admin/licenses                           │
│     │                   │   ?status=ACTIVE      │                                │
│     │                   │──────────────────────>│                                │
│     │                   │                       │                                │
│     │                   │                       │  3. licenses 조회             │
│     │                   │                       │   JOIN users, license_plans   │
│     │                   │                       │                                │
│     │                   │  4. 라이선스 목록 반환│                                │
│     │                   │<──────────────────────│                                │
│     │                   │                       │                                │
│     │  5. 목록 표시     │                       │                                │
│     │<──────────────────│                       │                                │
│     │                   │                       │                                │
│     │  === 라이선스 상세 조회 ===               │                                │
│     │                   │                       │                                │
│     │  6. 라이선스 클릭 │                       │                                │
│     │──────────────────>│                       │                                │
│     │                   │                       │                                │
│     │                   │  7. 상세 정보 요청    │                                │
│     │                   │   GET /api/v1/admin/licenses/{id}                      │
│     │                   │──────────────────────>│                                │
│     │                   │                       │                                │
│     │                   │                       │  8. 상세 정보 조회            │
│     │                   │                       │   - 활성화 이력               │
│     │                   │                       │   - 결제 정보                 │
│     │                   │                       │                                │
│     │                   │  9. 상세 정보 반환    │                                │
│     │                   │<──────────────────────│                                │
│     │                   │                       │                                │
│     │ 10. 상세 모달 표시│                       │                                │
│     │<──────────────────│                       │                                │
│     │                   │                       │                                │
│     │  === 라이선스 일시정지 ===                │                                │
│     │                   │                       │                                │
│     │ 11. 일시정지 클릭 │                       │                                │
│     │──────────────────>│                       │                                │
│     │                   │                       │                                │
│     │                   │ 12. 일시정지 요청     │                                │
│     │                   │   POST /api/v1/admin/licenses/{id}/suspend             │
│     │                   │   { reason: "..." }   │                                │
│     │                   │──────────────────────>│                                │
│     │                   │                       │                                │
│     │                   │                       │ 13. licenses UPDATE           │
│     │                   │                       │   status = SUSPENDED          │
│     │                   │                       │                                │
│     │                   │ 14. 완료 응답         │                                │
│     │                   │<──────────────────────│                                │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/pages/AdminPage.tsx` | `fetchLicenses()`, `handleSuspendLicense()` |
| Backend | `licensing/controller/LicenseAdminController.java` | `getLicenses()`, `suspendLicense()` |
| Backend | `licensing/service/LicenseService.java` | `searchLicenses()`, `suspendLicense()` |

---

### 3.5 결제 내역 관리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              결제 내역 관리 흐름                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  [관리자]           [AdminPage]              [Backend]                          │
│     │                   │                       │                                │
│     │  === 결제 내역 조회 ===                   │                                │
│     │                   │                       │                                │
│     │  1. 결제 탭 클릭  │                       │                                │
│     │──────────────────>│                       │                                │
│     │                   │                       │                                │
│     │                   │  2. 결제 내역 요청    │                                │
│     │                   │   GET /api/admin/orders                                │
│     │                   │   ?status=COMPLETED   │                                │
│     │                   │──────────────────────>│                                │
│     │                   │                       │                                │
│     │                   │                       │  3. orders 조회               │
│     │                   │                       │   JOIN users                  │
│     │                   │                       │   ORDER BY created_at DESC    │
│     │                   │                       │                                │
│     │                   │  4. 결제 내역 반환    │                                │
│     │                   │<──────────────────────│                                │
│     │                   │                       │                                │
│     │  5. 내역 표시     │                       │                                │
│     │<──────────────────│                       │                                │
│     │                   │                       │                                │
│     │  === 환불 처리 ===│                       │                                │
│     │                   │                       │                                │
│     │  6. 환불 버튼 클릭│                       │                                │
│     │──────────────────>│                       │                                │
│     │                   │                       │                                │
│     │                   │  7. 환불 요청         │                                │
│     │                   │   POST /api/payments/cancel                            │
│     │                   │   { paymentKey, reason }                               │
│     │                   │──────────────────────>│                                │
│     │                   │                       │                                │
│     │                   │                       │  8. TossPayments 취소 API      │
│     │                   │                       │                                │
│     │                   │                       │  9. orders UPDATE              │
│     │                   │                       │   status = REFUNDED           │
│     │                   │                       │                                │
│     │                   │                       │ 10. 라이선스 취소              │
│     │                   │                       │   revokeLicenseByOrderId()    │
│     │                   │                       │                                │
│     │                   │ 11. 환불 완료 응답    │                                │
│     │                   │<──────────────────────│                                │
│     │                   │                       │                                │
│     │ 12. 내역 갱신     │                       │                                │
│     │<──────────────────│                       │                                │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 관련 파일

| 위치 | 파일 | 주요 함수/라인 |
|------|------|---------------|
| Frontend | `src/pages/AdminPage.tsx` | `fetchOrders()`, `handleRefund()` |
| Backend | `controller/AdminController.java` | `getOrders()` |
| Backend | `controller/PaymentController.java` | `cancelPayment()` |
| Backend | `service/PaymentService.java` | `cancelPayment()` |

---

## 4. 부록

### 4.1 토큰 만료 시간

| 토큰 종류 | 만료 시간 | 설명 |
|----------|----------|------|
| Access Token | 1시간 | API 요청 인증용 |
| Refresh Token | 30일 | Access Token 갱신용 |
| OAuth Temp Token | 10분 | 소셜 로그인 회원가입 완료용 |

### 4.2 사용자 권한 코드

| 코드 | 권한 | 설명 |
|------|------|------|
| 000 | Admin | 시스템 관리자 (모든 권한) |
| 001 | Manager | 매니저 (사용자/라이선스 관리) |
| 002 | User | 일반 사용자 |

### 4.3 라이선스 상태

| 상태 | 설명 |
|------|------|
| PENDING | 결제 대기 |
| ACTIVE | 활성화 |
| EXPIRED_GRACE | 유예 기간 만료 |
| EXPIRED_HARD | 완전 만료 |
| SUSPENDED | 일시 정지 |
| REVOKED | 취소됨 (복구 불가) |

### 4.4 주문 상태

| 상태 | 설명 |
|------|------|
| PENDING | 결제 대기 |
| COMPLETED | 결제 완료 |
| FAILED | 결제 실패 |
| REFUNDED | 환불 완료 |
| PARTIAL_REFUND | 부분 환불 |

---

*문서 작성: Claude Code*
*최종 수정: 2026-01-19*
