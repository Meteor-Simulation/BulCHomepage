# BulC Homepage 테이블 정의서

> 최종 업데이트: 2026-02-06
> PostgreSQL 16

## 주요 변경사항 (2026-02-06)

**Users PK 마이그레이션: email → UUID**
- `users.email` VARCHAR PK → `users.id` UUID PK로 변경
- 모든 FK 참조를 `user_email` → `user_id` (UUID)로 변경
- JWT 토큰의 subject를 email → userId로 변경

## 테이블 목록

| No | 테이블명 | 설명 | 분류 |
|----|----------|------|------|
| 1 | user_roles | 유저 등급 테이블 | 사용자 |
| 2 | countries | 국가 테이블 | 사용자 |
| 3 | users | 유저 테이블 | 사용자 |
| 4 | user_social_accounts | 소셜 계정 연동 테이블 | 사용자 |
| 5 | email_verifications | 이메일 인증 테이블 | 사용자 |
| 6 | password_reset_tokens | 비밀번호 재설정 토큰 테이블 | 사용자 |
| 7 | token_blacklist | 토큰 블랙리스트 테이블 | 사용자 |
| 8 | refresh_tokens | 리프레시 토큰 테이블 (RTR) | 사용자 |
| 9 | products | 상품 종류 테이블 | 결제 |
| 10 | price_plans | 상품 가격 테이블 | 결제 |
| 11 | promotions | 프로모션/쿠폰 테이블 | 결제 |
| 12 | subscriptions | 유저 구독 관리 테이블 | 결제 |
| 13 | billing_keys | 빌링키 테이블 (자동결제용) | 결제 |
| 14 | subscription_payments | 구독 결제 이력 테이블 | 결제 |
| 15 | payments | 결제 테이블 | 결제 |
| 16 | payment_details | 결제 상세 테이블 | 결제 |
| 17 | activity_logs | 활동 로그 테이블 | 로그 |
| 18 | user_change_logs | 유저 정보 변경 로그 테이블 | 로그 |
| 19 | admin_logs | 관리자 로그 테이블 | 로그 |
| 20 | license_plans | 라이선스 플랜 테이블 | 라이선스 |
| 21 | license_plan_entitlements | 플랜 기능 권한 테이블 | 라이선스 |
| 22 | licenses | 라이선스 테이블 | 라이선스 |
| 23 | license_activations | 라이선스 활성화 테이블 | 라이선스 |
| 24 | revoked_offline_tokens | 무효화된 오프라인 토큰 테이블 | 라이선스 |

---

## 사용자 도메인

### 1. user_roles (유저 등급 테이블)

사용자 권한 등급을 정의하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | code | VARCHAR(10) | NO | - | PK | 역할 코드 |
| 2 | role | VARCHAR(50) | NO | - | - | 역할명 |

**기본 데이터**
| code | role | 설명 |
|------|------|------|
| 000 | admin | 관리자 |
| 001 | manager | 매니저 |
| 002 | user | 일반 사용자 |

---

### 2. countries (국가 테이블)

지원 국가 목록 (통화, 언어 설정 등에 사용)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | code | VARCHAR(10) | NO | - | PK | 국가 코드 (KR/US/JP 등) |
| 2 | name | VARCHAR(50) | NO | - | - | 국가명 |
| 3 | currency | VARCHAR(10) | NO | 'USD' | - | 결제 통화 (KRW/USD) |
| 4 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |

**기본 데이터**
| code | name | currency |
|------|------|----------|
| KR | 대한민국 | KRW |
| CN | 중국 | USD |
| JP | 일본 | USD |
| US | 미국 | USD |
| EU | 유럽 | USD |
| RU | 러시아 | USD |

---

### 3. users (유저 테이블)

사용자 기본 정보를 저장하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | PK | 사용자 UUID |
| 2 | email | VARCHAR(255) | NO | - | UNIQUE | 이메일 (로그인 ID) |
| 3 | password_hash | VARCHAR(255) | YES | - | - | 비밀번호 해시 (소셜 로그인은 NULL) |
| 4 | roles_code | VARCHAR(10) | NO | '002' | FK → user_roles.code | 역할 코드 |
| 5 | name | VARCHAR(100) | YES | - | - | 이름 (결제 시 입력) |
| 6 | phone | VARCHAR(20) | YES | - | - | 전화번호 (결제 시 입력) |
| 7 | country_code | VARCHAR(10) | YES | 'KR' | FK → countries.code | 국가 코드 |
| 8 | is_active | BOOLEAN | NO | TRUE | - | 계정 활성화 상태 |
| 9 | deactivated_at | TIMESTAMP | YES | - | - | 계정 비활성화 시점 |
| 10 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 11 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**인덱스**
- `idx_users_email`: email (UNIQUE)
- `idx_users_is_active`: is_active
- `idx_users_roles_code`: roles_code

---

### 4. user_social_accounts (소셜 계정 연동 테이블)

OAuth 제공자별 사용자 ID를 저장하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | user_id | UUID | NO | - | FK → users.id | 사용자 UUID |
| 3 | provider | VARCHAR(20) | NO | - | - | 소셜 제공자 (NAVER/KAKAO/GOOGLE) |
| 4 | provider_id | VARCHAR(255) | NO | - | - | 소셜 플랫폼 사용자 고유 ID |
| 5 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |

**제약조건**
- `uk_social_accounts_provider`: UNIQUE (provider, provider_id)

---

### 5. email_verifications (이메일 인증 테이블)

이메일 인증 코드를 관리하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | email | VARCHAR(255) | NO | - | UNIQUE | 인증할 이메일 |
| 3 | verification_code | VARCHAR(6) | NO | - | - | 6자리 인증 코드 |
| 4 | expires_at | TIMESTAMP | NO | - | - | 인증 코드 만료 시각 |
| 5 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |

---

### 6. password_reset_tokens (비밀번호 재설정 토큰 테이블)

비밀번호 재설정 인증 코드를 관리하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | email | VARCHAR(255) | NO | - | UNIQUE | 재설정할 계정 이메일 |
| 3 | reset_code | VARCHAR(6) | NO | - | - | 6자리 영숫자 인증 코드 |
| 4 | expires_at | TIMESTAMP | NO | - | - | 코드 만료 시간 (기본 10분) |
| 5 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |

---

### 7. token_blacklist (토큰 블랙리스트 테이블)

로그아웃된 JWT 토큰을 관리하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | token | VARCHAR(500) | NO | - | - | 블랙리스트에 등록된 JWT 토큰 |
| 3 | user_id | UUID | NO | - | - | 사용자 UUID |
| 4 | expires_at | TIMESTAMP | NO | - | - | 토큰 만료 시간 (만료 후 자동 삭제) |
| 5 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |

**인덱스**
- `idx_token_blacklist_token`: token
- `idx_token_blacklist_expires_at`: expires_at

---

### 8. refresh_tokens (리프레시 토큰 테이블)

RTR (Refresh Token Rotation) 방식의 리프레시 토큰 관리 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | user_id | UUID | NO | - | - | 사용자 UUID |
| 3 | token | VARCHAR(500) | NO | - | - | 현재 유효한 리프레시 토큰 |
| 4 | device_id | VARCHAR(255) | YES | - | - | 디바이스 식별자 (멀티 디바이스 지원) |
| 5 | device_info | VARCHAR(500) | YES | - | - | 디바이스 정보 (User-Agent 등) |
| 6 | expires_at | TIMESTAMP | NO | - | - | 토큰 만료 시간 |
| 7 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 8 | last_used_at | TIMESTAMP | YES | - | - | 마지막 사용 시간 |

**인덱스**
- `idx_refresh_tokens_user_id`: user_id
- `idx_refresh_tokens_token`: token
- `idx_refresh_tokens_device_id`: device_id

---

## 결제 도메인

### 9. products (상품 종류 테이블)

판매 상품을 정의하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | code | VARCHAR(3) | NO | - | PK | 상품 코드 (000~999) |
| 2 | name | VARCHAR(255) | NO | - | - | 상품명 |
| 3 | description | TEXT | YES | - | - | 상품 설명 |
| 4 | is_active | BOOLEAN | NO | TRUE | - | 활성화 여부 |
| 5 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 6 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**기본 데이터**
| code | name | description |
|------|------|-------------|
| 001 | BUL:C | 화재시뮬레이션 |

---

### 10. price_plans (상품 가격 테이블)

상품별 요금제를 정의하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | product_code | VARCHAR(3) | NO | - | FK → products.code | 상품 코드 |
| 3 | name | VARCHAR(100) | NO | - | - | 요금제명 |
| 4 | description | VARCHAR(100) | YES | - | - | 요금제 설명 (예: 1년, 6개월) |
| 5 | price | DECIMAL(18,2) | NO | - | - | 가격 |
| 6 | currency | VARCHAR(10) | NO | 'KRW' | - | 통화 |
| 7 | is_active | BOOLEAN | NO | TRUE | - | 활성화 여부 |
| 8 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 9 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

---

### 11. promotions (프로모션/쿠폰 테이블)

할인 쿠폰 및 프로모션을 관리하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | code | VARCHAR(50) | NO | - | UNIQUE | 프로모션 코드 (사용자 입력용) |
| 3 | name | VARCHAR(100) | NO | - | - | 프로모션명 |
| 4 | discount_type | INTEGER | NO | - | - | 할인 유형 (퍼센트 값, 예: 10 = 10%) |
| 5 | discount_value | DECIMAL(18,2) | NO | - | - | 할인 값 |
| 6 | product_code | VARCHAR(3) | YES | - | FK → products.code | 특정 상품에만 적용 (NULL이면 전체) |
| 7 | usage_limit | INTEGER | YES | - | - | 사용 횟수 제한 (NULL이면 무제한) |
| 8 | usage_count | INTEGER | NO | 0 | - | 현재까지 사용된 횟수 |
| 9 | valid_from | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 유효 시작일 |
| 10 | valid_until | TIMESTAMP | YES | - | - | 유효 종료일 |
| 11 | is_active | BOOLEAN | NO | TRUE | - | 활성화 여부 |
| 12 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 13 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**인덱스**
- `idx_promotions_code`: code
- `idx_promotions_product_code`: product_code
- `idx_promotions_is_active`: is_active
- `idx_promotions_valid_from`: valid_from
- `idx_promotions_valid_until`: valid_until

---

### 12. subscriptions (유저 구독 관리 테이블)

사용자의 구독 현황을 관리하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | user_id | UUID | YES | - | FK → users.id | 사용자 UUID |
| 3 | product_code | VARCHAR(3) | NO | - | FK → products.code | 상품 코드 |
| 4 | price_plan_id | BIGINT | NO | - | FK → price_plans.id | 요금제 ID |
| 5 | status | VARCHAR(1) | NO | 'A' | - | 구독 상태 |
| 6 | start_date | TIMESTAMP | NO | - | - | 구독 시작일 |
| 7 | end_date | TIMESTAMP | NO | - | - | 구독 종료일 |
| 8 | auto_renew | BOOLEAN | NO | FALSE | - | 자동 갱신 여부 |
| 9 | billing_key_id | BIGINT | YES | - | FK → billing_keys.id | 자동결제용 빌링키 ID |
| 10 | next_billing_date | TIMESTAMP | YES | - | - | 다음 결제 예정일 |
| 11 | billing_cycle | VARCHAR(20) | YES | 'YEARLY' | - | 결제 주기 |
| 12 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 13 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**구독 상태 (status)**
| 값 | 설명 |
|----|------|
| A | 활성 (Active) |
| E | 만료 (Expired) |
| C | 취소 (Canceled) |

**결제 주기 (billing_cycle)**
| 값 | 설명 |
|----|------|
| MONTHLY | 월간 |
| QUARTERLY | 분기별 |
| YEARLY | 연간 |

---

### 13. billing_keys (빌링키 테이블)

자동결제용 카드 정보를 저장하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | user_id | UUID | NO | - | FK → users.id | 사용자 UUID |
| 3 | billing_key | VARCHAR(255) | NO | - | - | 토스페이먼츠 빌링키 |
| 4 | customer_key | VARCHAR(255) | NO | - | - | 고객 식별키 (UUID) |
| 5 | card_company | VARCHAR(50) | YES | - | - | 카드사명 |
| 6 | card_number | VARCHAR(20) | YES | - | - | 마스킹된 카드번호 (앞6자리****뒤4자리) |
| 7 | card_type | VARCHAR(20) | YES | - | - | 카드 유형 |
| 8 | owner_type | VARCHAR(20) | YES | - | - | 소유자 유형 (개인/법인) |
| 9 | is_default | BOOLEAN | NO | FALSE | - | 기본 결제 수단 여부 |
| 10 | is_active | BOOLEAN | NO | TRUE | - | 활성화 여부 |
| 11 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 12 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**인덱스**
- `idx_billing_keys_user_id`: user_id
- `idx_billing_keys_is_active`: is_active

---

### 14. subscription_payments (구독 결제 이력 테이블)

구독 자동결제 이력을 추적하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | subscription_id | BIGINT | NO | - | FK → subscriptions.id | 구독 ID |
| 3 | billing_key_id | BIGINT | YES | - | FK → billing_keys.id | 빌링키 ID |
| 4 | payment_key | VARCHAR(255) | YES | - | - | 토스페이먼츠 결제 키 |
| 5 | order_id | VARCHAR(255) | NO | - | - | 주문 ID |
| 6 | amount | DECIMAL(15,2) | NO | - | - | 결제 금액 |
| 7 | status | VARCHAR(20) | NO | 'PENDING' | - | 결제 상태 |
| 8 | billing_date | DATE | NO | - | - | 결제 예정일 |
| 9 | paid_at | TIMESTAMP | YES | - | - | 결제 완료 시각 |
| 10 | failure_reason | TEXT | YES | - | - | 실패 사유 |
| 11 | retry_count | INT | NO | 0 | - | 결제 재시도 횟수 |
| 12 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 13 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**결제 상태 (status)**
| 값 | 설명 |
|----|------|
| PENDING | 결제 대기 |
| SUCCESS | 결제 성공 |
| FAILED | 결제 실패 |
| CANCELED | 결제 취소 |

**인덱스**
- `idx_subscription_payments_subscription_id`: subscription_id
- `idx_subscription_payments_billing_date`: billing_date
- `idx_subscription_payments_status`: status

---

### 15. payments (결제 테이블)

결제 및 환불 정보를 관리하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | user_id | UUID | YES | - | FK → users.id | 사용자 UUID |
| 3 | user_email | VARCHAR(255) | NO | - | - | 결제 시점 이메일 (스냅샷) |
| 4 | user_name | VARCHAR(100) | YES | - | - | 결제 시점 이름 (스냅샷) |
| 5 | subscription_id | BIGINT | YES | - | FK → subscriptions.id | 구독 ID |
| 6 | price_plan_id | BIGINT | YES | - | FK → price_plans.id | 요금제 ID |
| 7 | amount | DECIMAL(18,2) | NO | - | - | 결제 금액 |
| 8 | currency | VARCHAR(10) | NO | 'KRW' | - | 통화 |
| 9 | status | VARCHAR(1) | NO | 'P' | - | 결제 상태 |
| 10 | order_name | VARCHAR(255) | YES | - | - | 주문명 |
| 11 | paid_at | TIMESTAMP | YES | - | - | 결제 완료 시각 |
| 12 | refunded_at | TIMESTAMP | YES | - | - | 환불 시각 |
| 13 | refund_amount | DECIMAL(18,2) | YES | - | - | 환불 금액 |
| 14 | refund_reason | TEXT | YES | - | - | 환불 사유 |
| 15 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 16 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

> **참고**: `user_email`은 결제 시점 이메일의 스냅샷이며, FK가 아닙니다. 이메일이 변경되어도 결제 기록에는 결제 당시 이메일이 유지됩니다.

**결제 상태 (status)**
| 값 | 설명 |
|----|------|
| P | 대기 (Pending) |
| C | 완료 (Completed) |
| F | 실패 (Failed) |
| R | 환불 (Refunded) |

---

### 16. payment_details (결제 상세 테이블)

PG사 연동 정보를 저장하는 테이블 (payments와 1:1 관계)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | payment_id | BIGINT | NO | - | PK, FK → payments.id | 결제 ID |
| 2 | payment_method | VARCHAR(50) | YES | - | - | 결제 수단 코드 |
| 3 | payment_provider | VARCHAR(50) | YES | - | - | PG사 (TOSS) |
| 4 | order_id | VARCHAR(100) | YES | - | - | 가맹점 주문 ID |
| 5 | payment_key | VARCHAR(255) | YES | - | - | 토스페이먼츠 결제 키 |
| 6 | card_company | VARCHAR(50) | YES | - | - | 카드사명 |
| 7 | card_number | VARCHAR(50) | YES | - | - | 마스킹된 카드번호 |
| 8 | installment_months | INT | YES | - | - | 할부 개월수 (0: 일시불) |
| 9 | approve_no | VARCHAR(50) | YES | - | - | 카드 승인번호 |
| 10 | easy_pay_provider | VARCHAR(50) | YES | - | - | 간편결제 제공자 |
| 11 | bank_code | VARCHAR(20) | YES | - | - | 은행 코드 (가상계좌/계좌이체) |
| 12 | bank_name | VARCHAR(50) | YES | - | - | 은행명 |
| 13 | account_number | VARCHAR(50) | YES | - | - | 가상계좌 번호 |
| 14 | due_date | TIMESTAMP | YES | - | - | 입금 기한 (가상계좌) |
| 15 | depositor_name | VARCHAR(100) | YES | - | - | 입금자명 (가상계좌) |
| 16 | settlement_status | VARCHAR(20) | YES | - | - | 정산 상태 (계좌이체) |
| 17 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 18 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**결제 수단 코드 (payment_method)**
| 값 | 설명 |
|----|------|
| CARD | 카드 |
| VIRTUAL_ACCOUNT | 가상계좌 |
| TRANSFER | 계좌이체 |
| MOBILE | 휴대폰 |
| EASY_PAY | 간편결제 |

---

## 로그 도메인

### 17. activity_logs (활동 로그 테이블)

로그인, 구매, 환불 등 사용자 활동을 기록하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | user_id | UUID | YES | - | FK → users.id | 사용자 UUID |
| 3 | action | VARCHAR(50) | NO | - | - | 활동 유형 |
| 4 | target_type | VARCHAR(50) | YES | - | - | 대상 타입 |
| 5 | target_id | BIGINT | YES | - | - | 대상 ID |
| 6 | description | TEXT | YES | - | - | 상세 설명 |
| 7 | ip_address | VARCHAR(50) | YES | - | - | IP 주소 |
| 8 | user_agent | TEXT | YES | - | - | 브라우저 정보 |
| 9 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |

**활동 유형 (action)**
| 값 | 설명 |
|----|------|
| login | 로그인 |
| logout | 로그아웃 |
| purchase | 구매 |
| refund | 환불 |
| subscription_start | 구독 시작 |
| subscription_cancel | 구독 취소 |

---

### 18. user_change_logs (유저 정보 변경 로그 테이블)

사용자 정보 변경 이력을 기록하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | user_id | UUID | YES | - | - | 변경된 사용자 UUID |
| 3 | changed_field | VARCHAR(50) | NO | - | - | 변경된 필드명 |
| 4 | old_value | TEXT | YES | - | - | 이전 값 |
| 5 | new_value | TEXT | YES | - | - | 새 값 |
| 6 | changed_by_id | UUID | YES | - | - | 변경한 사용자 UUID |
| 7 | change_reason | TEXT | YES | - | - | 변경 사유 |
| 8 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |

---

### 19. admin_logs (관리자 로그 테이블)

관리자 작업 이력을 기록하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | BIGINT | NO | AUTO | PK | 기본키 |
| 2 | admin_id | UUID | NO | - | FK → users.id | 관리자 UUID |
| 3 | action | VARCHAR(100) | NO | - | - | 작업 유형 |
| 4 | target_type | VARCHAR(50) | NO | - | - | 대상 타입 |
| 5 | target_id | BIGINT | YES | - | - | 대상 ID |
| 6 | description | TEXT | YES | - | - | 작업 설명 |
| 7 | ip_address | VARCHAR(50) | YES | - | - | IP 주소 |
| 8 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |

---

## 라이선스 도메인

### 20. license_plans (라이선스 플랜 테이블)

라이선스 플랜/정책 템플릿을 정의하는 테이블 (Admin UI에서 관리)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | PK | 기본키 |
| 2 | product_id | UUID | NO | - | - | 상품 ID |
| 3 | code | VARCHAR(64) | NO | - | - | 플랜 코드 (Admin UI 표시용) |
| 4 | name | VARCHAR(255) | NO | - | - | 플랜명 |
| 5 | description | TEXT | YES | - | - | 플랜 설명 |
| 6 | license_type | VARCHAR(32) | NO | - | - | 라이선스 유형 |
| 7 | duration_days | INT | NO | - | - | 기본 유효기간 (일) |
| 8 | grace_days | INT | NO | 0 | - | EXPIRED_GRACE 유예기간 (일) |
| 9 | max_activations | INT | NO | 1 | - | 최대 기기 활성화 수 |
| 10 | max_concurrent_sessions | INT | NO | 1 | - | 최대 동시 세션 수 |
| 11 | allow_offline_days | INT | NO | 0 | - | 오프라인 허용 일수 |
| 12 | is_active | BOOLEAN | NO | TRUE | - | 활성화 여부 |
| 13 | is_deleted | BOOLEAN | NO | FALSE | - | 삭제 여부 (Soft Delete) |
| 14 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 15 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**라이선스 유형 (license_type)**
| 값 | 설명 |
|----|------|
| SUBSCRIPTION | 구독형 |
| PERPETUAL | 영구 라이선스 |
| TRIAL | 체험판 |

---

### 21. license_plan_entitlements (플랜 기능 권한 테이블)

플랜별 활성화 기능 목록을 정의하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | PK | 기본키 |
| 2 | plan_id | UUID | NO | - | FK → license_plans.id | 플랜 ID |
| 3 | entitlement_key | VARCHAR(100) | NO | - | - | 기능 식별자 |

**기능 식별자 예시 (entitlement_key)**
| 값 | 설명 |
|----|------|
| core-simulation | 기본 시뮬레이션 |
| advanced-visualization | 고급 시각화 |
| export-reports | 리포트 내보내기 |

---

### 22. licenses (라이선스 테이블)

라이선스 정보를 저장하는 테이블 (Licensing BC Aggregate Root)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | PK | 기본키 |
| 2 | owner_type | VARCHAR(20) | NO | - | - | 소유자 유형 (USER/ORG) |
| 3 | owner_id | UUID | NO | - | - | 소유자 ID |
| 4 | product_id | UUID | NO | - | - | 상품 ID |
| 5 | plan_id | UUID | YES | - | FK → license_plans.id | 플랜 ID |
| 6 | license_type | VARCHAR(20) | NO | - | - | 라이선스 유형 |
| 7 | usage_category | VARCHAR(30) | NO | - | - | 사용 용도 |
| 8 | status | VARCHAR(20) | NO | - | - | 라이선스 상태 |
| 9 | issued_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 발급일시 |
| 10 | valid_from | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 유효 시작일 |
| 11 | valid_until | TIMESTAMP | YES | - | - | 유효 종료일 |
| 12 | policy_snapshot | JSONB | YES | - | - | 발급 시점 정책 스냅샷 |
| 13 | license_key | VARCHAR(50) | YES | - | UNIQUE | 라이선스 키 |
| 14 | source_order_id | UUID | YES | - | - | 원본 주문 ID |
| 15 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 16 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**소유자 유형 (owner_type)**
| 값 | 설명 |
|----|------|
| USER | 개인 |
| ORG | 조직 |

**사용 용도 (usage_category)**
| 값 | 설명 |
|----|------|
| COMMERCIAL | 상업용 |
| RESEARCH | 연구용 |
| EDUCATION | 교육용 |
| INTERNAL | 내부평가용 |

**라이선스 상태 (status)**
| 값 | 설명 |
|----|------|
| PENDING | 대기 |
| ACTIVE | 활성 |
| EXPIRED_GRACE | 유예기간 |
| EXPIRED_HARD | 완전 만료 |
| SUSPENDED | 정지 |
| REVOKED | 폐기 |

---

### 23. license_activations (라이선스 활성화 테이블)

기기 활성화 정보를 저장하는 테이블 (라이선스별 기기 슬롯)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | PK | 기본키 |
| 2 | license_id | UUID | NO | - | FK → licenses.id | 라이선스 ID |
| 3 | device_fingerprint | VARCHAR(255) | NO | - | - | 기기 식별 해시 |
| 4 | device_display_name | VARCHAR(100) | YES | - | - | 기기 표시명 |
| 5 | status | VARCHAR(20) | NO | - | - | 활성화 상태 |
| 6 | activated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 활성화 일시 |
| 7 | last_seen_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 마지막 확인 일시 |
| 8 | client_version | VARCHAR(50) | YES | - | - | 클라이언트 버전 |
| 9 | client_os | VARCHAR(100) | YES | - | - | 클라이언트 OS |
| 10 | last_ip | VARCHAR(45) | YES | - | - | 마지막 IP 주소 |
| 11 | offline_token | VARCHAR(2000) | YES | - | - | 오프라인 토큰 |
| 12 | offline_token_expires_at | TIMESTAMP | YES | - | - | 오프라인 토큰 만료일 |
| 13 | deactivated_at | TIMESTAMP | YES | - | - | 비활성화 일시 |
| 14 | deactivated_reason | VARCHAR(50) | YES | - | - | 비활성화 사유 |
| 15 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 생성일시 |
| 16 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 수정일시 |

**활성화 상태 (status)**
| 값 | 설명 |
|----|------|
| ACTIVE | 활성 |
| INACTIVE | 비활성 |
| EXPIRED | 만료 |

---

### 24. revoked_offline_tokens (무효화된 오프라인 토큰 테이블)

무효화된 오프라인 토큰 목록 (탈취 대응)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | PK/FK | 설명 |
|----|--------|-------------|------|--------|-------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | PK | 기본키 |
| 2 | license_id | UUID | NO | - | FK → licenses.id | 라이선스 ID |
| 3 | activation_id | UUID | YES | - | - | 활성화 ID |
| 4 | device_fingerprint | VARCHAR(255) | YES | - | - | 기기 식별 해시 |
| 5 | token_hash | VARCHAR(255) | NO | - | - | 토큰 해시 |
| 6 | revoked_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | 무효화 일시 |
| 7 | reason | VARCHAR(255) | YES | - | - | 무효화 사유 |

---

## ERD 관계도

```
[사용자 도메인]
user_roles (1) ──────────────────────────> users (N)
                                              │ (UUID PK)
countries (1) ────────────────────────────────┘
                                              │
                    ┌─────────────────────────┼────────────────────────────────┐
                    ▼                         ▼                                ▼
        user_social_accounts          email_verifications              password_reset_tokens
        (user_id UUID FK)                     │
                    ┌─────────────────────────┼────────────────────────────────┬────────────────┐
                    ▼                         ▼                                ▼                ▼
            activity_logs              user_change_logs                  admin_logs      refresh_tokens
            (user_id UUID)             (user_id UUID)                  (admin_id UUID)    (user_id UUID)

                                       token_blacklist
                                       (user_id UUID)

[결제 도메인]
products (1) ─────────────────────────────> price_plans (N)
    │                                             │
    ▼                                             ▼
subscriptions (N) <───────────────────────────────┘
(user_id UUID FK)
    │
    ├─────────────────────> billing_keys (N)
    │                       (user_id UUID FK)
    ▼                            │
subscription_payments (N) <──────┘
    │
payments (N) ─────────────────────> payment_details (1:1)
(user_id UUID FK)

[라이선스 도메인]
license_plans (1) ─────────────────────> license_plan_entitlements (N)
    │
    ▼
licenses (N) ─────────────────────────────> owner_id는 users.id 참조 가능
    │
    ├─────────────────────> license_activations (N)
    │
    └─────────────────────> revoked_offline_tokens (N)
```

---

## 결제 흐름

1. **유저 회원가입**: `users` 테이블에 레코드 생성
2. **이메일 인증**: `email_verifications` 테이블에서 인증 코드 관리
3. **상품 선택**: `products` + `price_plans` 조회
4. **결제 진행**: `payments` 테이블에 pending 상태로 생성
5. **토스페이먼츠 콜백**: `payment_details`에 결제 정보 저장, `payments.status` → completed
6. **구독 생성**: `subscriptions` 레코드 생성
7. **라이선스 발급**: `licenses` 테이블에 라이선스 생성
8. **환불 요청**: `payments.status` → refunded, 환불 정보 기록

---

## 구독 자동결제 흐름

1. **카드 등록**: `billing_keys` 테이블에 빌링키 저장
2. **자동갱신 활성화**: `subscriptions.auto_renew` = TRUE, `billing_key_id` 설정
3. **다음 결제일 계산**: `subscriptions.next_billing_date` 설정
4. **스케줄러 실행**: 매일 오전 9시 갱신 대상 조회
5. **결제 요청**: `subscription_payments` 레코드 생성, 토스페이먼츠 API 호출
6. **결제 성공**: `subscription_payments.status` → SUCCESS, 구독 기간 갱신
7. **결제 실패**: `subscription_payments.status` → FAILED, 재시도 스케줄링

---

## 라이선스 상태 흐름

```
PENDING ──────> ACTIVE ──────> EXPIRED_GRACE ──────> EXPIRED_HARD
                  │
                  │ (정지 시)
                  ▼
              SUSPENDED ──────> (복구 가능)
                  │
                  │ (폐기 시)
                  ▼
               REVOKED (복구 불가)
```
